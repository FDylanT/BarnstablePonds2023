---
title: "PondGraphics"
author: "Dylan Titmuss"
date: "2023-12-26"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Load packages
```{r include = FALSE}
### Load packages

library(tidyverse)
library(gsw)
library(trend)
library(egg)
library(DT)
library(pals)
library(sf)
library(cowplot)
library(rkt)
```

First run chunks 2-8 of `PondShiny.Rmd` script.

### Pt. 1: Summary of new data and data characteristics
```{r}
months <- ponds %>%
  group_by(Station.name, Date) %>%
  summarise(Month = Month[1])

mo <- ggplot(months, aes(x = Month)) +
  geom_histogram(binwidth = 1, fill = "lightblue", col = "black") +
  scale_x_continuous(breaks = c(min(months$Month, na.rm = TRUE):max(months$Month, na.rm = TRUE))) +
  labs(y = "Cumulative sampling events") +
  theme_classic() +
  theme(panel.grid.minor.x = element_blank())

years <- ponds %>%
  group_by(Station.name, Lat, Long) %>%
  summarise(num_years = n_distinct(Year),
            last_year = max(Year))

ye <- ggplot(years, aes(x = num_years)) +
  geom_histogram(binwidth = 1, fill = "lightblue", col = "black") +
  labs(x = "Number of years sampled", y = "Number of ponds") +
  theme_classic()

f1a.i <- ggarrange(ye, mo, ncol = 2)

ggsave("figures/f1a.i.png", f1a.i, width = 6.5, height = 3, units = "in", dpi = 600)

pie <- years %>%
  mutate(bin = case_when(num_years <= 5 ~ "[1,5]",
                         num_years > 5 & num_years <= 10 ~ "(5,10]",
                         num_years > 10 & num_years <= 15 ~ "(10,15]",
                         num_years > 15 ~ ">15")) %>%
  group_by(bin) %>%
  summarise(n = n())

f1a.ii <- ggplot(pie, aes(x = "", y = n, fill = factor(bin, levels = c("[1,5]", "(5,10]", "(10,15]", ">15")))) +
  geom_bar(width = 1, stat = "identity", col = "black") +
  coord_polar("y", start = 0, direction = -1) +
  geom_text(aes(label = paste0(n, "\n(", percent(n/sum(n)), ")")),
            position = position_stack(vjust = 0.5), size = 3) +
  labs(fill = "Number of\nyears sampled") +
  theme_classic() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())

ggsave("figures/f1a.ii.png", f1a.ii, width = 4.5, height = 3, units = "in", dpi = 600)
```

### Pt. 1b
```{r}
sf_use_s2(FALSE)

# get Massachusetts outline
mass <- read_sf("/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/gshhg-shp-2.3.7/GSHHS_shp/f/GSHHS_f_L1.shp") %>%
  st_make_valid() %>%
  st_crop(xmin = -71, xmax = -69, ymin = 41, ymax = 42.25)

years <- years %>%
  arrange(desc(num_years))

N <- ggplot() +
  geom_sf(data = mass) +
  geom_point(data = years, aes(x = Long, y = Lat, fill = num_years),
             shape = 21, size = 1.25, stroke = 0.25) +
  scale_fill_viridis(option = "plasma", name = "N years\nsampled") +
  xlim(-70.65, -69.95) +
  ylim(41.55, 42.07) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())

years <- years %>%
  arrange(desc(last_year))

L <- ggplot() +
  geom_sf(data = mass) +
  geom_point(data = years, aes(x = Long, y = Lat, fill = last_year),
             shape = 21, size = 1.25, stroke = 0.25) +
  scale_fill_viridis(option = "viridis", name = "Last year\nsampled") +
  xlim(-70.65, -69.95) +
  ylim(41.55, 42.07) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())

f1a.iii <- ggarrange(N, L, ncol = 2)

ggsave("figures/f1a.iii.png", f1a.iii, width = 6.5, height = 3, units = "in", dpi = 600, bg = "white")
```

### Wrangle layer-specific data
```{r}
setwd("~/Desktop/Repos/CapeCodPonds2023")

## define "consistently sampled" ##

# surface data
allSurface_cont <- allSurface %>%
  group_by(Station.name) %>%
  filter(min(Year) <= quantile(2001:2023)[2],
         max(Year) >= quantile(2001:2023)[4]) %>%
  filter(n() >= (2023 - 2001)/2) %>%
  ungroup()

allSurface_pre <- allSurface_cont %>%
  filter(Year <= 2011)                    # change if desired

allSurface_post <- allSurface_cont %>%
  filter(Year >= 2012)                    # change if desired

# bottom data
allBottom_cont <- allBottom %>%
  group_by(Station.name) %>%
  filter(min(Year) <= quantile(2001:2023)[2],
         max(Year) >= quantile(2001:2023)[4]) %>%
  filter(n() >= (2023 - 2001)/2) %>%
  ungroup()

allBottom_pre <- allBottom_cont %>%
  filter(Year <= 2011)                    # change if desired

allBottom_post <- allBottom_cont %>%
  filter(Year >= 2012)                    # change if desired
```

### Pt. 1b cont.

######
- rotate scale bars

```{r}
params <- c("Secchi", "MLD", "TN", "TP", "NtP", "Chla", "Temp", "DO", "DO_sat", "Alk")

# function for dealing with log10(0)
zero_sub <- function(x) {
  str <- strsplit(as.character(x), ".", fixed = TRUE)[[1]]
  if(str[1] != 0) {
    exp <- str_count(str[1], "0")
    return(10^exp)
  } else {
    exp <- str_count(str[2], "0") + 1
    return(10^-exp)
  }
}

limits <- allSurface %>%
  mutate(layer = "s",
         Chla = NA) %>%
  rbind(cbind(allBottom, layer = "b")) %>%  # bind allS & allB
  filter(Year >= 2016) %>%
  group_by(Station.name, layer) %>%
  summarise(across(where(is.numeric) & !Year, ~ mean(.x, na.rm = TRUE))) %>%
  mutate(across(where(is.numeric), ~ ifelse(is.nan(.), NA, .)))

limits <- limits %>%
    mutate(TN = if_else(TN == 0, zero_sub(sort(unique(limits$TN))[2]), TN),
           TP = if_else(TP == 0, zero_sub(sort(unique(limits$TP))[2]), TP),
           Chla = if_else(Chla == 0, zero_sub(sort(unique(limits$Chla))[2]), Chla))

recent_surf <- allSurface %>%
  filter(Year >= 2016) %>%
  group_by(Station.name) %>%
  summarise(across(where(is.numeric) & !Year, ~ mean(.x, na.rm = TRUE))) %>%
  mutate(across(where(is.numeric), ~ ifelse(is.nan(.), NA, .))) %>%
  mutate(TN = if_else(TN == 0, zero_sub(sort(unique(limits$TN))[2]), TN),
         TP = if_else(TP == 0, zero_sub(sort(unique(limits$TP))[2]), TP),
         Chla = if_else(Chla == 0, zero_sub(sort(unique(limits$Chla))[2]), Chla))

recent_bott <- allBottom %>%
  filter(Year >= 2016) %>%
  group_by(Station.name) %>%
  summarise(across(where(is.numeric) & !Year, ~ mean(.x, na.rm = TRUE))) %>%
  mutate(across(where(is.numeric), ~ ifelse(is.nan(.), NA, .))) %>%
  mutate(TN = if_else(TN == 0, zero_sub(sort(unique(limits$TN))[2]), TN),
         TP = if_else(TP == 0, zero_sub(sort(unique(limits$TP))[2]), TP))

surf_list <- lapply(params, function(param) {
  ggplot() +
    geom_sf(data = mass) +
    geom_point(data = recent_surf[recent_surf[[paste0(param, "_flag")]] == 2, ],
               aes(x = Long, y = Lat, fill = get(param)),
               shape = 21) +
    scale_fill_gradientn(colors = parula(100),
                         limits = c(min(c(recent_surf[[param]],
                                          recent_bott[[param]]), na.rm = TRUE),
                                    max(c(recent_surf[[param]],
                                          recent_bott[[param]]), na.rm = TRUE)),
                         name = param) +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Surface")) +
    theme_classic() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank())
})

bott_list <- lapply(params[c(3:4, 7:10)], function(param) {
  ggplot() +
    geom_sf(data = mass) +
    geom_point(data = recent_bott[recent_bott[[paste0(param, "_flag")]] == 2, ],
               aes(x = Long, y = Lat, fill = get(param)),
               shape = 21) +
    scale_fill_gradientn(colors = parula(100),
                         limits = c(min(c(recent_surf[[param]],
                                          recent_bott[[param]]), na.rm = TRUE),
                                    max(c(recent_surf[[param]],
                                          recent_bott[[param]]), na.rm = TRUE)),
                         name = param) +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Bottom")) +
    theme_classic() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank())
})

surf_list[[1]] <- surf_list[[1]] +
  scale_fill_gradientn(colors = parula(100), name = "Secchi\ndepth (m)  ") +
  labs(title = "")

surf_list[[2]] <- surf_list[[2]] +
  scale_fill_gradientn(colors = parula(100), name = "Mixed-layer\ndepth (m)") +     # not working inside `labs()`
  labs(title = "")

surf_list[[3]] <- surf_list[[3]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = expression("TN (μg L"^-1*")"),
                       limits = c(min(c(recent_surf$TN,
                                        recent_bott$TN), na.rm = TRUE),
                                  max(c(recent_surf$TN,
                                        recent_bott$TN), na.rm = TRUE)))

bott_list[[1]] <- bott_list[[1]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = expression("TN (μg L"^-1*")"),
                       limits = c(min(c(recent_surf$TN,
                                        recent_bott$TN), na.rm = TRUE),
                                  max(c(recent_surf$TN,
                                        recent_bott$TN), na.rm = TRUE)))

surf_list[[4]] <- surf_list[[4]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = expression("TP (μg L"^-1*")"),
                       limits = c(min(c(recent_surf$TP,
                                        recent_bott$TP), na.rm = TRUE),
                                  max(c(recent_surf$TP,
                                        recent_bott$TP), na.rm = TRUE)))

bott_list[[2]] <- bott_list[[2]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = expression("TP (μg L"^-1*")"),
                       limits = c(min(c(recent_surf$TP,
                                        recent_bott$TP), na.rm = TRUE),
                                  max(c(recent_surf$TP,
                                        recent_bott$TP), na.rm = TRUE)))

# ggplot(recent_surf, aes(NtP)) + geom_histogram()  ## not really log-distributed

# quantile(recent_surf$NtP, probs = c(0.9, 0.95, 0.975, 1), na.rm = TRUE)
# min(c(recent_surf$NtP, recent_bott$NtP), na.rm = TRUE)

top <- 134   # upper bound of color scale

surf_list[[5]] <- surf_list[[5]] +
  geom_point(data = recent_surf[recent_surf[["NtP"]] < 16, ],   ### this puts N-limited ponds on top
             aes(x = Long, y = Lat, fill = NtP),
             shape = 21) +
  scale_fill_gradientn(colors = c("firebrick4", "firebrick2", parula(11)), name = "N:P",
                       limits = c(0.01, top),
                       values = rescale(c(0, (16 - 0.000000000000001),
                                          16, 16 + ((top-16)/10) * (1:10))),
                       breaks = c(16, 50, 100, 150),
                       na.value = "#F9FB0E")

surf_list[[6]] <- surf_list[[6]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10",
                       name = expression("Chl-a (μg L"^-1*")"))

surf_list[[7]] <- surf_list[[7]] +
  scale_fill_gradientn(colors = parula(100), name = "Temp (°C)   ",
                       limits = c(min(c(recent_surf$Temp,
                                        recent_bott$Temp), na.rm = TRUE),
                                  max(c(recent_surf$Temp,
                                        recent_bott$Temp), na.rm = TRUE)))

bott_list[[3]] <- bott_list[[3]] +
  scale_fill_gradientn(colors = parula(100), name = "Temp (°C)   ",
                       limits = c(min(c(recent_surf$Temp,
                                        recent_bott$Temp), na.rm = TRUE),
                                  max(c(recent_surf$Temp,
                                        recent_bott$Temp), na.rm = TRUE)))

surf_list[[8]] <- surf_list[[8]] +
  scale_fill_gradientn(colors = c("firebrick2", "white", "white", "#0D77DA"),
                       name = expression("DO (mg L"^-1*")"),
                       limits = c(min(c(recent_surf$DO,
                                        recent_bott$DO), na.rm = TRUE),
                                  max(c(recent_surf$DO,
                                        recent_bott$DO), na.rm = TRUE)),
                       values = rescale(c(min(c(recent_surf$DO,
                                                recent_bott$DO), na.rm = TRUE),
                                          (3 - 0.000000000000001), 3,
                                          max(c(recent_surf$DO,
                                                recent_bott$DO), na.rm = TRUE))))

bott_list[[4]] <- bott_list[[4]] +
  scale_fill_gradientn(colors = c("firebrick2", "white", "white", "#0D77DA"),
                       name = expression("DO (mg L"^-1*")"),
                       limits = c(min(c(recent_surf$DO,
                                        recent_bott$DO), na.rm = TRUE),
                                  max(c(recent_surf$DO,
                                        recent_bott$DO), na.rm = TRUE)),
                       values = rescale(c(min(c(recent_surf$DO,
                                                recent_bott$DO), na.rm = TRUE),
                                          (3 - 0.000000000000001), 3,
                                          max(c(recent_surf$DO,
                                                recent_bott$DO), na.rm = TRUE))))

surf_list[[9]] <- surf_list[[9]] +
  scale_fill_gradientn(colors = parula(100), name = "DO sat. (%)",
                       limits = c(min(c(recent_surf$DO_sat,
                                        recent_bott$DO_sat), na.rm = TRUE),
                                  max(c(recent_surf$DO_sat,
                                        recent_bott$DO_sat), na.rm = TRUE)))

bott_list[[5]] <- bott_list[[5]] +
  scale_fill_gradientn(colors = parula(100), name = "DO sat. (%)",
                       limits = c(min(c(recent_surf$DO_sat,
                                        recent_bott$DO_sat), na.rm = TRUE),
                                  max(c(recent_surf$DO_sat,
                                        recent_bott$DO_sat), na.rm = TRUE)))

# quantile(c(recent_surf$Alk, recent_bott$Alk), probs = c(0.9, 0.95, 0.975, 1), na.rm = TRUE)
# min(c(recent_surf$Alk, recent_bott$Alk), na.rm = TRUE)

top <- 61   # upper bound of color scale

surf_list[[10]] <- surf_list[[10]] +
  scale_fill_gradientn(colors = parula(100), limits = c(0, top),
                       breaks = c(20, 40, 60),
                       name = expression("Alk (mg L"^-1*")"),
                       na.value = "#F9FB0E")

bott_list[[6]] <- bott_list[[6]] +
  scale_fill_gradientn(colors = parula(100), limits = c(0, top),
                       breaks = c(20, 40, 60),
                       name = expression("Alk (mg L"^-1*")"),
                       na.value = "#F9FB0E")

f1b.i <- plot_grid(surf_list[[1]], surf_list[[2]],
                   surf_list[[3]], bott_list[[1]],
                   surf_list[[4]], bott_list[[2]],
                   surf_list[[5]], surf_list[[6]], ncol = 2, nrow = 4, align = "hv")

ggsave("figures/f1b.i.png", f1b.i, width = 6.5, height = 9, units = "in", dpi = 600, bg = "white")

f1b.ii <- plot_grid(surf_list[[7]], bott_list[[3]],
                    surf_list[[8]], bott_list[[4]],
                    surf_list[[9]], bott_list[[5]],
                    surf_list[[10]], bott_list[[6]], ncol = 2, nrow = 4, align = "hv")

ggsave("figures/f1b.ii.png", f1b.ii, width = 6.5, height = 9, units = "in", dpi = 600)
```

### Temporary(?): Fish space map & vertical-vs-volumetric plot
```{r}
fish1 <- ggplot() +
  geom_sf(data = mass) +
  geom_point(data = recent_surf[recent_surf$VerticalFishSpace == 0, ],
             aes(x = Long, y = Lat), fill = "firebrick2",
             shape = 21) +
  geom_point(data = recent_surf[(!is.na(recent_surf$VerticalFishSpace) &
                                   recent_surf$VerticalFishSpace != 0), ],
             aes(x = Long, y = Lat, fill = log10(VerticalFishSpace)),
             shape = 21) +
  scale_fill_gradientn(colors = parula(100),
                       breaks = c(log10(0.1), log10(0.3),log10(1), log10(3), log10(10)),
                       labels = c(0.1, 0.3, 1, 3, 10),
                       name = "Vertical\nFish Space (m)") +
  xlim(-70.65, -69.95) +
  ylim(41.55, 42.07) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(face = "bold"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())

fish2 <- ggplot() +
  geom_sf(data = mass) +
  geom_point(data = recent_surf[recent_surf$VolumetricFishSpace == 0, ],
             aes(x = Long, y = Lat), fill = "firebrick2",
             shape = 21) +
  geom_point(data = recent_surf[(!is.na(recent_surf$VolumetricFishSpace) &
                                   recent_surf$VolumetricFishSpace != 0), ],
             aes(x = Long, y = Lat, fill = log10(VolumetricFishSpace)),
             shape = 21) +
  scale_fill_gradientn(colors = parula(100),
                       breaks = c(log10(3*10^3), 4, 5, 6),
                       labels = c(3*10^3, 1*10^4, 1*10^5, 1*10^6),
                       name = expression("Volumetric\nFish Space (m"^3*")")) +
  xlim(-70.65, -69.95) +
  ylim(41.55, 42.07) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(face = "bold"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())

f1b.iii <- plot_grid(fish1, fish2,
                     ncol = 2, nrow = 1, align = "hv")

ggsave("figures/f1b.iii.png", f1b.iii, width = 6.5, height = 2.5, units = "in", dpi = 600, bg = "white")

ggplot() +
  geom_point(data = recent_surf[recent_surf$VerticalFishSpace < 10, ],
             aes(x = VerticalFishSpace, y = VolumetricFishSpace)) +
  labs(x = "Vertical Fish Space (m)", y = expression("Volumetric Fish Space (m"^3*")")) +
  theme_linedraw()

ggsave("figures/FishSpace_prop.png", width = 6.5, height = 4, units = "in", dpi = 600)
```

### Pt. 2: Ecoregion thresholds (Secchi, Chla, TN, TP)
Ponds:
-- Hathaway S (BA)
-- Micah (BA)
-- Slough (BR)
-- Pine (BR)
-- Flax (DE)
-- Slough (TR)
-- Duck (WE)
-- Spectacle (WE)

```{r}
# calculate 75%ile using allSurface
ecoregion <- allSurface %>%
  filter(str_detect(Station.name, "BA-594-01") | # Hathaway Pond (South)
         str_detect(Station.name, "BA-797-01") | # Micah Pond
         str_detect(Station.name, "BR-321-01") | # Slough Pond
         str_detect(Station.name, "BR-335-01") | # Pine Pond
         str_detect(Station.name, "DE-355-01") | # Flax Pond
         str_detect(Station.name, "TR-53-01")  | # Slough Pond
         str_detect(Station.name, "WE-76-01")  | # Duck Pond
         str_detect(Station.name, "WE-64-01"))   # Spectacle Pond)

  # Secchi negated to account for inverted significance of values
thresh_Secchi <- quantile(-ecoregion$Secchi, na.rm = TRUE)[4]   ### -4.11 vs -4.15
thresh_chla <- quantile(ecoregion$Chla, na.rm = TRUE)[4]   ### 3.06 vs 3.56
thresh_TN <- quantile(ecoregion$TN, na.rm = TRUE)[4]
thresh_TP <- quantile(ecoregion$TP, na.rm = TRUE)[4]

## calculate 75%ile using "ponds" for comparison
ecoregion2 <- ponds %>%
  filter(Month == 8 | Month == 9) %>%
  filter(str_detect(Station.name, "BA-594-01") | # Hathaway Pond (South)
         str_detect(Station.name, "BA-797-01") | # Micah Pond
         str_detect(Station.name, "BR-321-01") | # Slough Pond
         str_detect(Station.name, "BR-335-01") | # Pine Pond
         str_detect(Station.name, "DE-355-01") | # Flax Pond
         str_detect(Station.name, "TR-53-01")  | # Slough Pond
         str_detect(Station.name, "WE-76-01")  | # Duck Pond
         str_detect(Station.name, "WE-64-01"))   # Spectacle Pond)

thresh_Secchi2 <- quantile(-ecoregion2$Secchi, na.rm = TRUE)[4]
thresh_chla2 <- quantile(ecoregion2$Chla, na.rm = TRUE)[4]
thresh_TN2 <- quantile(ecoregion2$TN, na.rm = TRUE)[4]
thresh_TP2 <- quantile(ecoregion2$TP, na.rm = TRUE)[4]

# calculate 75%ile threshold values per year (using "ponds")
eco_annual75 <- ecoregion2 %>%
  group_by(Year) %>%
  summarise(Secchi = quantile(-Secchi, na.rm = TRUE)[4],
            Chla = quantile(Chla, na.rm = TRUE)[4],
            TN = quantile(TN, na.rm = TRUE)[4],
            TP = quantile(TP, na.rm = TRUE)[4])

# quantile(ecoregion2$Secchi[ecoregion2$Year == 2001], na.rm = TRUE)

##########

### use allSurface_cont/allBottom to calc 25th %iles
thresh_Secchi_S <- quantile(-allSurface_cont$Secchi, na.rm = TRUE)[2]
thresh_chla_S <- quantile(allSurface_cont$Chla, na.rm = TRUE)[2]
thresh_TN_S <- quantile(allSurface_cont$TN, na.rm = TRUE)[2]
thresh_TP_S <- quantile(allSurface_cont$TP, na.rm = TRUE)[2]

thresh_TN_B <- quantile(allBottom_cont$TN, na.rm = TRUE)[2]
thresh_TP_B <- quantile(allBottom_cont$TP, na.rm = TRUE)[2]

## annual thresholds
eco_annual25 <- allSurface %>%
  group_by(Year) %>%
  summarise(Secchi = quantile(-Secchi, na.rm = TRUE)[2],
            Chla = quantile(Chla, na.rm = TRUE)[2],
            TN = quantile(TN, na.rm = TRUE)[2],
            TP = quantile(TP, na.rm = TRUE)[2])
```

### Distribution plots
```{r}
### split time period in half
### put both time periods on same panel; lines instead of filled bars; diff. color for each
### two panels (surface + bottom) per param
### Chla & Secchi on same graphic (both surf panels)

colors <- c("2001-2011" = "dodgerblue", "2012-2023" = "violetred")

Secchi1 <- ggplot(mapping = aes(x = Secchi, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, aes(fill = "2001-2011"), col = NA, alpha = 0.5, bins = 20) +
  geom_histogram(data = allSurface_post, aes(fill = "2012-2023"), col = NA, alpha = 0.5, bins = 20) +
  geom_vline(xintercept = 2, linetype = "dashed") +
  geom_vline(xintercept = 4.5, linetype = "dashed") +
  geom_vline(xintercept = -thresh_Secchi, col = "gold") +
  geom_vline(xintercept = -thresh_Secchi_S) +
  labs(x = "Secchi Depth (m)", y = "Proportion", title = "") +
  scale_fill_manual(values = colors) +
  theme_classic() +
  theme(legend.position = c(0.85, 0.8),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.margin = margin(0, 1, 1, 1, "pt"),
        legend.text = element_text(size = 6),
        legend.key.size = unit(0.1, "in"))

MLD1 <- ggplot(mapping = aes(x = MLD, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, aes(fill = "2001-2011"), col = NA, fill = "dodgerblue",
                 alpha = 0.5, bins = 15) +
  geom_histogram(data = allSurface_post, aes(fill = "2012-2023"), col = NA, fill = "violetred",
                 alpha = 0.5, bins = 15) +
  labs(x = "Mixed-layer Depth (m)", y = "Proportion", title = "") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Chla1 <- ggplot(mapping = aes(x = log10(Chla), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(1), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_chla), col = "gold") +
  geom_vline(xintercept = log10(thresh_chla_S)) +
  scale_x_continuous(breaks = c(-1, 0, 1, 2),
                     labels = 10^c(-1, 0, 1, 2)) +
  labs(x = expression("Chl-a (μg L"^-1*")"), y = "Proportion", title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

NtP1 <- ggplot(mapping = aes(x = log10(NtP), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(16), col = "forestgreen") +
  scale_x_continuous(breaks = c(1, 2, 3),
                     labels = 10^c(1, 2, 3)) +
  labs(x = "N:P", y = "Proportion", title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

# ggplot_build(obj)$layout$panel_scales_y[[1]]$range$range

TN1 <- ggplot(mapping = aes(x = log10(TN), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5,
                 binwidth = 0.05) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5,
                 binwidth = 0.05) +
  geom_vline(xintercept = log10(11.42 * 14.0067), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "gold") +
  geom_vline(xintercept = log10(thresh_TN_S)) +
  scale_x_continuous(limits = c(1.8, 3.8),
                     breaks = c(2, 3),
                     labels = 10^c(2, 3)) +
  ylim(0, 0.13) +
  labs(x = expression("TN (μg L"^-1*")"), y = "Proportion", title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN2 <- ggplot(mapping = aes(x = log10(TN), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, binwidth = 0.05) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, binwidth = 0.05) +
  geom_vline(xintercept = log10(11.42 * 14.0067), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "gold") +
  geom_vline(xintercept = log10(thresh_TN_B)) +
  scale_x_continuous(limits = c(1.8, 3.8),
                     breaks = c(2, 3),
                     labels = 10^c(2, 3)) +
  ylim(0, 0.13) +
  labs(x = expression("TN (μg L"^-1*")"), y = "Proportion", title = "Bottom") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP1 <- ggplot(mapping = aes(x = log10(TP), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(0.24 * 30.973762), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "gold") +
  geom_vline(xintercept = log10(thresh_TP_S)) +
  scale_x_continuous(limits = c(-0.2, 3.2),
                     breaks = c(0, 1, 2, 3),
                     labels = 10^c(0, 1, 2, 3)) +
  ylim(0, 0.1) +
  labs(x = expression("TP (μg L"^-1*")"), y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP2 <- ggplot(mapping = aes(x = log10(TP), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(0.24 * 30.973762), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "gold") +
  geom_vline(xintercept = log10(thresh_TP_B)) +
  scale_x_continuous(limits = c(-0.2, 3.2),
                     breaks = c(0, 1, 2, 3),
                     labels = 10^c(0, 1, 2, 3)) +
  ylim(0, 0.1) +
  labs(x = expression("TP (μg L"^-1*")"), y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp1 <- ggplot(mapping = aes(x = Temp, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(6, 29.4) +
  ylim(0, 0.09) +
  labs(x = "Temperature (°C)", y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp2 <- ggplot(mapping = aes(x = Temp, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(6, 29.4) +
  ylim(0, 0.09) +
  labs(x = "Temperature (°C)", y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO1 <- ggplot(mapping = aes(x = DO, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(0, 15.75) +
  ylim(0, 0.28) +
  labs(x = expression("DO (mg L"^-1*")"), y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO2 <- ggplot(mapping = aes(x = DO, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(0, 15.75) +
  ylim(0, 0.28) +
  labs(x = expression("DO (mg L"^-1*")"), y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO_sat1 <- ggplot(mapping = aes(x = DO_sat, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(0, 180) +
  ylim(0, 0.27) +
  labs(x = "DO Saturation (%)", y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO_sat2 <- ggplot(mapping = aes(x = DO_sat, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(0, 180) +
  ylim(0, 0.27) +
  labs(x = "DO Saturation (%)", y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Alk1 <- ggplot(mapping = aes(x = Alk, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(0, 130) +
  ylim(0, 0.19) +
  labs(x = expression("Alkalinity (mg L"^-1*")"), y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Alk2 <- ggplot(mapping = aes(x = Alk, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(0, 130) +
  ylim(0, 0.19) +
  labs(x = expression("Alkalinity (mg L"^-1*")"), y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

f2a.i <- ggarrange(Secchi1, MLD1, Chla1, NtP1, TN1, TN2, TP1, TP2, ncol = 2)

ggsave("figures/f2a.i.png", f2a.i, width = 6.5, height = 9, units = "in", dpi = 600)

f2a.ii <- ggarrange(Temp1, Temp2, DO1, DO2, DO_sat1, DO_sat2, Alk1, Alk2, ncol = 2)

ggsave("figures/f2a.ii.png", f2a.ii, width = 6.5, height = 9, units = "in", dpi = 600)
```

### Same as above but density plots
```{r}
hist(na.omit(allSurface_pre$Secchi), prob = TRUE)
lines(density(na.omit(allSurface_pre$Secchi)))

hist(log10(na.omit(allSurface_pre$Secchi)), prob = TRUE)
lines(density(log10(na.omit(allSurface_pre$Secchi))))

colors <- c("2001-2011" = "dodgerblue", "2012-2023" = "violetred")

Secchi1.1 <- ggplot(mapping = aes(x = Secchi)) +
  geom_density(data = allSurface_pre, aes(col = "2001-2011"), alpha = 0.5) +
  geom_density(data = allSurface_post, aes(col = "2012-2023"), alpha = 0.5) +
  geom_vline(xintercept = 2, linetype = "dashed") +
  geom_vline(xintercept = 4.5, linetype = "dashed") +
  geom_vline(xintercept = -thresh_Secchi, col = "darkgoldenrod2") +
  geom_vline(xintercept = -thresh_Secchi_S) +
  labs(x = "Secchi Depth (m)", title = "Surface") +
  scale_color_manual(values = colors) +
  theme_classic() +
  theme(legend.position = c(0.85, 0.8),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.margin = margin(0, 1, 1, 1, "pt"),
        legend.text = element_text(size = 6),
        legend.key.size = unit(0.1, "in"))

Chla1.1 <- ggplot(mapping = aes(x = log10(Chla))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(1), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_chla), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_chla_S)) +
  scale_x_continuous(breaks = c(-1, 0, 1, 2),
                     labels = 10^c(-1, 0, 1, 2)) +
  labs(x = expression("Chl-a (μg L"^-1*")"), title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

NtP1.1 <- ggplot(mapping = aes(x = log10(Chla))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(16), col = "forestgreen") +
  scale_x_continuous(breaks = c(1, 2, 3),
                     labels = 10^c(1, 2, 3)) +
  labs(x = "N:P", title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN1.1 <- ggplot(mapping = aes(x = log10(TN))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(11.42 * 14.0067), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TN_S)) +
  scale_x_continuous(limits = c(1.8, 3.8),
                     breaks = c(2, 3),
                     labels = 10^c(2, 3)) +
  #ylim(0, 0.13) +
  labs(x = expression("TN (μg L"^-1*")"), title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN2.1 <- ggplot(mapping = aes(x = log10(TN))) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(11.42 * 14.0067), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TN_B)) +
  scale_x_continuous(limits = c(1.8, 3.8),
                     breaks = c(2, 3),
                     labels = 10^c(2, 3)) +
  #ylim(0, 0.13) +
  labs(x = expression("TN (μg L"^-1*")"), title = "Bottom") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP1.1 <- ggplot(mapping = aes(x = log10(TP))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(0.24 * 30.973762), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TP_S)) +
  scale_x_continuous(limits = c(-0.2, 3.2),
                     breaks = c(0, 1, 2, 3),
                     labels = 10^c(0, 1, 2, 3)) +
  #ylim(0, 0.1) +
  labs(x = expression("TP (μg L"^-1*")")) +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP2.1 <- ggplot(mapping = aes(x = log10(TP))) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(0.24 * 30.973762), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TP_B)) +
  scale_x_continuous(limits = c(-0.2, 3.2),
                     breaks = c(0, 1, 2, 3),
                     labels = 10^c(0, 1, 2, 3)) +
  #ylim(0, 0.1) +
  labs(x = expression("TP (μg L"^-1*")")) +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp1.1 <- ggplot(mapping = aes(x = Temp)) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  xlim(6, 29.4) +
  #ylim(0, 0.09) +
  labs(x = "Temperature (°C)") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp2.1 <- ggplot(mapping = aes(x = Temp)) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  xlim(6, 29.4) +
  #ylim(0, 0.09) +
  labs(x = "Temperature (°C)") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO1.1 <- ggplot(mapping = aes(x = DO)) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(0, 15.75) +
  #ylim(0, 0.28) +
  labs(x = expression("DO (mg L"^-1*")")) +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO2.1 <- ggplot(mapping = aes(x = DO)) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(0, 15.75) +
  #ylim(0, 0.28) +
  labs(x = expression("DO (mg L"^-1*")")) +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

f2b.i <- ggarrange(Secchi1.1, MLD1.1, Chla1.1, NtP1.1, TN1.1, TN2.1, TP1.1, TP2.1, ncol = 2)

ggsave("figures/f2b.i.png", f2b.i, width = 6.5, height = 9, units = "in", dpi = 600)

f2b.ii <- ggarrange(Temp1.1, Temp2.1, DO1.1, DO2.1, DO_sat1.1, DO_sat2.1, Alk1.1, Alk2.1, ncol = 2)

ggsave("figures/f2b.ii.png", f2b.ii, width = 6.5, height = 9, units = "in", dpi = 600)
```

### Stats for above
```{r}
ks.test(allSurface_pre$Secchi, allSurface_post$Secchi)
ks.test(allSurface_pre$MLD, allSurface_post$MLD)
ks.test(allSurface_pre$Chla, allSurface_post$Chla)
ks.test(log10(allSurface_pre$Chla), log10(allSurface_post$Chla))
ks.test(allSurface_pre$TN, allSurface_post$TN)
ks.test(log10(allSurface_pre$TN), log10(allSurface_post$TN))
ks.test(allSurface_pre$TP, allSurface_post$TP)
ks.test(log10(allSurface_pre$TP), log10(allSurface_post$TP))
ks.test(allSurface_pre$Temp, allSurface_post$Temp)
ks.test(allSurface_pre$DO, allSurface_post$DO)
ks.test(allSurface_pre$DO_sat, allSurface_post$DO_sat)

ks.test(allBottom_pre$TN, allBottom_post$TN)
ks.test(allBottom_pre$TP, allBottom_post$TP)
ks.test(allBottom_pre$Temp, allBottom_post$Temp)
ks.test(allBottom_pre$DO, allBottom_post$DO)
ks.test(allBottom_pre$DO_sat, allBottom_post$DO_sat)
```

### Pt. 3: Plot annual threshold values

```{r}
m1 <- lm(eco_annual75$Secchi ~ eco_annual75$Year)
summary(m1)

m1.1 <- lm(eco_annual25$Secchi ~ eco_annual25$Year)
summary(m1.1)

p1 <- ggplot() +
  geom_point(data = eco_annual75, aes(x = Year, y = Secchi), shape = 1, color = "blue") +
  geom_point(data = eco_annual25, aes(x = Year, y = Secchi), shape = 1, color = "red") +
  geom_smooth(data = eco_annual75, aes(x = Year, y = Secchi), method = "lm", se = FALSE) +
  geom_smooth(data = eco_annual25, aes(x = Year, y = Secchi), method = "lm", se = FALSE, col = "red",
              linetype = "22") +
  geom_hline(yintercept = -4.5, linetype = "dashed") +
  geom_hline(yintercept = -2, linetype = "dashed") +
  annotate("text", x = 2004, y = -0.4, label = "slope: -0.04\nP-value: 0.295", col = "blue", size = 3) +
  annotate("text", x = 2020, y = -0.4, label = "slope: -0.01\nP-value: 0.604", col = "red", size = 3) +
  ylim(-8, 0) +
  labs(y = "Secchi Depth (m)") +
  theme_linedraw()
  
m2 <- lm(eco_annual75$Chla ~ eco_annual75$Year)
summary(m2)

m2.1 <- lm(eco_annual25$Chla ~ eco_annual25$Year)
summary(m2.1)

p2 <- ggplot() +
  geom_point(data = eco_annual75, aes(x = Year, y = Chla), shape = 1, color = "blue") +
  geom_point(data = eco_annual25, aes(x = Year, y = Chla), shape = 1, color = "red") +
  geom_smooth(data = eco_annual75, aes(x = Year, y = Chla), method = "lm", se = FALSE) +
  geom_smooth(data = eco_annual25, aes(x = Year, y = Chla), method = "lm", se = FALSE, col = "red",
              linetype = "22") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  annotate("text", x = 2004, y = 9, label = "slope: 0.07\nP-value: 0.396", col = "blue", size = 3) +
  annotate("text", x = 2020, y = 9, label = "slope: -0.02\nP-value: 0.427", col = "red", size = 3) +
  scale_y_continuous(limits = c(0, 9.5), breaks = c(0, 2, 4, 6, 8)) +
  labs(y = expression("Chl-a (μg L"^-1*")")) +
  theme_linedraw()

m3 <- lm(eco_annual75$TN ~ eco_annual75$Year)
summary(m3)

m3.1 <- lm(eco_annual25$TN ~ eco_annual25$Year)
summary(m3.1)

p3 <- ggplot() +
  geom_point(data = eco_annual75, aes(x = Year, y = TN), shape = 1, color = "blue") +
  geom_point(data = eco_annual25, aes(x = Year, y = TN), shape = 1, color = "red") +
  geom_smooth(data = eco_annual75, aes(x = Year, y = TN), method = "lm", se = FALSE) +
  geom_smooth(data = eco_annual25, aes(x = Year, y = TN), method = "lm", se = FALSE, col = "red",
              linetype = "22") +
  geom_hline(yintercept = 11.42 * 14.0067, linetype = "dashed") +
  annotate("text", x = 2004, y = 600, label = "slope: 5.784\nP-value: 0.166", col = "blue", size = 3) +
  annotate("text", x = 2020, y = 600, label = "slope: 0.1494\nP-value: 0.941", col = "red", size = 3) +
  ylim(0, 640) +
  labs(y = expression("TN (μg L"^-1*")")) +
  theme_linedraw()

m4 <- lm(eco_annual75$TP ~ eco_annual75$Year)
summary(m4)

m4.1 <- lm(eco_annual25$TP ~ eco_annual25$Year)
summary(m4.1)

p4 <- ggplot() +
  geom_point(data = eco_annual75, aes(x = Year, y = TP), shape = 1, color = "blue") +
  geom_point(data = eco_annual25, aes(x = Year, y = TP), shape = 1, color = "red") +
  geom_smooth(data = eco_annual75, aes(x = Year, y = TP), method = "lm", se = FALSE) +
  geom_smooth(data = eco_annual25, aes(x = Year, y = TP), method = "lm", se = FALSE, col = "red",
              linetype = "22") +
  geom_hline(yintercept = 0.24 * 30.973762, linetype = "dashed") +
  annotate("text", x = 2004, y = 28, label = "slope: 0.450\nP-value: 0.004", col = "blue", size = 3) +
  annotate("text", x = 2020, y = 28, label = "slope: 0.294\nP-value: <0.001", col = "red", size = 3) +
  ylim(0, 30) +
  labs(y = expression("TP (μg L"^-1*")")) +
  theme_linedraw()

f3 <- ggarrange(p1, p2, p3, p4, ncol = 2)

ggsave("figures/f3.png", f3, width = 6.5, height = 5, units = "in", dpi = 600)
```

### Pt. 4: Maps w/ trends in all parameters
- Calc "recent" (2016+) & annually in table

######
- rotate & combine scale bars

```{r}
params <- c("Secchi", "MLD", "TN", "TP", "NtP", "Chla", "Temp", "DO", "DO_sat", "Alk")

surf_list2 <- lapply(params, function(param) {
  ggplot() +
    geom_sf(data = mass) +
    geom_point(data = slopes_surf2[!is.na(slopes_surf2[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), col = factor(sign(get(param)))),
               shape = 21) +
    geom_point(data = slopes_surf[!is.na(slopes_surf[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), fill = factor(sign(get(param)))),
               shape = 21) +
    scale_size_continuous(range = c(1, 4),
                          limits = c(sort(abs(c(slopes_surf[[param]],
                                                slopes_surf2[[param]],
                                                slopes_bott[[param]],
                                                slopes_bott2[[param]])))[1],
                                     sort(abs(c(slopes_surf[[param]],
                                                slopes_surf2[[param]],
                                                slopes_bott[[param]],
                                                slopes_bott2[[param]])), decreasing = TRUE)[1]),
                          name = "Trend\nmagnitude") +
    scale_color_manual(values = c("royalblue", "black", "firebrick"),
                       breaks = c(-1, 0, 1),
                       limits = factor(c(-1, 0, 1)),
                       labels = c("negative", "zero", "positive"),
                       name = paste(param, "trend\ndirection"),
                       na.translate = FALSE,
                       guide = "none") +
    scale_fill_manual(values = c("royalblue", "black", "firebrick"),
                      breaks = c(-1, 0, 1),
                      limits = factor(c(-1, 0, 1)),
                      labels = c("negative", "zero", "positive"),
                      name = paste(param, "trend\ndirection"),
                      na.translate = FALSE,
                      guide = "none") +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Surface", param)) +
    theme_classic() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank())
})

bott_list2 <- lapply(params[c(3:4, 7:10)], function(param) {
  ggplot() +
    geom_sf(data = mass) +
    geom_point(data = slopes_bott2[!is.na(slopes_bott2[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), col = factor(sign(get(param)))),
               shape = 21) +
    geom_point(data = slopes_bott[!is.na(slopes_bott[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), fill = factor(sign(get(param)))),
               shape = 21) +
    scale_size_continuous(range = c(1, 4),
                          limits = c(sort(abs(c(slopes_surf[[param]],
                                                slopes_surf2[[param]],
                                                slopes_bott[[param]],
                                                slopes_bott2[[param]])))[1],
                                     sort(abs(c(slopes_surf[[param]],
                                                slopes_surf2[[param]],
                                                slopes_bott[[param]],
                                                slopes_bott2[[param]])), decreasing = TRUE)[1]),
                          name = "Trend\nmagnitude") +
    scale_color_manual(values = c("royalblue", "black", "firebrick"),
                       breaks = c(-1, 0, 1),
                       limits = factor(c(-1, 0, 1)),
                       labels = c("negative", "zero", "positive"),
                       name = paste(param, "trend\ndirection"),
                       na.translate = FALSE,
                       guide = "none") +
    scale_fill_manual(values = c("royalblue", "black", "firebrick"), 
                      breaks = c(-1, 0, 1),
                      limits = factor(c(-1, 0, 1)),
                      labels = c("negative", "zero", "positive"),
                      name = paste(param, "trend\ndirection"),
                      na.translate = FALSE,
                      guide = "none") +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Bottom", param)) +
    theme_classic() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank())
})

surf_list2[[1]] <- surf_list2[[1]] +
  labs(title = "Secchi Depth (m)")

surf_list2[[2]] <- surf_list2[[2]] +
  labs(title = "Mixed-layer Depth (m)")

surf_list2[[3]] <- surf_list2[[3]] +
  labs(title = expression(bold("Surface TN (μg L"^-1*")")))

bott_list2[[1]] <- bott_list2[[1]] +
  labs(title = expression(bold("Bottom TN (μg L"^-1*")")))
  
surf_list2[[4]] <- surf_list2[[4]] +
  labs(title = expression(bold("Surface TP (μg L"^-1*")")))

bott_list2[[2]] <- bott_list2[[2]] +
  labs(title = expression(bold("Bottom TP (μg L"^-1*")")))

surf_list2[[5]] <- surf_list2[[5]] +
  labs(title = "Surface N:P Ratio")

surf_list2[[6]] <- surf_list2[[6]] +
  labs(title = expression(bold("Surface Chlorophyll-a (μg L"^-1*")")))

surf_list2[[7]] <- surf_list2[[7]] +
  labs(title = "Surface Temp (°C)")

bott_list2[[3]] <- bott_list2[[3]] +
  labs(title = "Bottom Temp (°C)")

surf_list2[[8]] <- surf_list2[[8]] +
  labs(title = expression(bold("Surface DO (mg L"^-1*")")))

bott_list2[[4]] <- bott_list2[[4]] +
  labs(title = expression(bold("Bottom DO (mg L"^-1*")")))

surf_list2[[9]] <- surf_list2[[9]] +
  labs(title = "Surface DO Saturation (%)")

bott_list2[[5]] <- bott_list2[[5]] +
  labs(title = "Bottom DO Saturation (%)")

surf_list2[[10]] <- surf_list2[[10]] +
  labs(title = expression(bold("Surface Alkalinity (mg L"^-1*")")))

bott_list2[[6]] <- bott_list2[[6]] +
  labs(title = expression(bold("Bottom Alkalinity (mg L"^-1*")")))

f4.1 <- ggarrange(surf_list2[[1]], surf_list2[[2]],
                surf_list2[[3]], bott_list2[[1]],
                surf_list2[[4]], bott_list2[[2]],
                surf_list2[[5]], surf_list2[[6]], ncol = 2)

ggsave("figures/f4.1.png", f4.1, width = 6.5, height = 9, units = "in", dpi = 600)

f4.2 <- ggarrange(surf_list2[[7]], bott_list2[[3]],
                surf_list2[[8]], bott_list2[[4]],
                surf_list2[[9]], bott_list2[[5]],
                surf_list2[[10]], bott_list2[[6]], ncol = 2)

ggsave("figures/f4.2.png", f4.2, width = 6.5, height = 9, units = "in", dpi = 600)
```

## Property-property
```{r}
# create function for dealing with log10(0)
zero_sub <- function(x) {
  str <- strsplit(as.character(x), ".", fixed = TRUE)[[1]]
  if(str[1] != 0) {
    exp <- str_count(str[1], "0")
    return(10^exp)
  } else {
    exp <- str_count(str[2], "0") + 1
    return(10^-exp)
  }
}

allSurface[allSurface$TP_flag == 2 &
             allSurface$Chla_flag == 2 &
             !is.na(allSurface$DevelopmentClass), ] %>%
  # mutate(TP = if_else(TP == 0, zero_sub(sort(unique(allSurface$TP))[2]), TP),
  #        Chla = if_else(Chla == 0, zero_sub(sort(unique(allSurface$Chla))[2]), Chla)) %>%
  ggplot(aes(x = TP, y = Chla, col = DevelopmentClass)) +
    geom_point(size = 2.5, shape = 1) +
    labs(x = expression("Total Phosphorus (μg L"^-1*")"),
         y = expression("Chlorophyll-a (μg L"^-1*")"),
         col = "% Buffer Developed") +
    facet_wrap(~ DepthClass) +
    scale_x_log10() +
    scale_y_log10() +
    theme_linedraw() +
    theme(panel.grid = element_blank())

ggsave("figures/property-property/Chla-TP.png", width = 8, height = 4, units = "in", dpi = 600)
```









###### Old

### DO standard
- All ponds on one graphic; hline @ 3 mg/L
```{r}
allBottom_pre %>%
  group_by(Station.name) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 41

length(unique(allBottom_pre$Station.name))  ## 49

allBottom_post %>%
  group_by(Station.name) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 42

length(unique(allBottom_post$Station.name))  ## 49

f3 <- ggplot(mapping = aes(x = Year, y = DO)) +
  geom_point(data = allBottom) +
  geom_point(data = allBottom_pre, col = "firebrick3") +
  geom_point(data = allBottom_post, col = "firebrick3") +
  geom_hline(yintercept = 3, linetype = "dashed") +
  scale_y_continuous(breaks = c(0, 4, 8, 12)) +
  theme_classic()

ggsave("figures/f3.png", f3, width = 5, height = 3.5, units = "in", dpi = 600)

allBottom_pre %>%
  group_by(Station.name) %>%
  filter(Final.Depth > 9) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 24

length(unique(allBottom_pre$Station.name[allBottom_pre$Final.Depth > 9]))  ## 25

allBottom_post %>%
  group_by(Station.name) %>%
  filter(Final.Depth > 9) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 25

length(unique(allBottom_post$Station.name[allBottom_post$Final.Depth > 9]))  ## 25

f4 <- ggplot(mapping = aes(x = Year, y = DO)) +
  geom_point(data = allBottom[allBottom$Final.Depth > 9, ]) +
  geom_point(data = allBottom_pre[allBottom_pre$Final.Depth > 9, ], col = "firebrick3") +
  geom_point(data = allBottom_post[allBottom_post$Final.Depth > 9, ], col = "firebrick3") +
  geom_hline(yintercept = 3, linetype = "dashed") +
  scale_y_continuous(limits = c(0, 12.25), breaks = c(0, 4, 8, 12)) +
  theme_classic()

ggsave("figures/f4.png", f4, width = 5, height = 3.5, units = "in", dpi = 600)
```
