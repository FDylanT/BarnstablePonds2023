---
title: "PondGraphics"
author: "Dylan Titmuss"
date: "2023-12-26"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Load packages
```{r setup, include = FALSE}
library(tidyverse)
library(egg)
library(pals)
library(scales)
```

## Load data
```{r}
setwd("~/Desktop/Repos/CapeCodPonds2023")

# load surface-only data
allSurface <- read.csv("data/AllPonds_Surface.csv") %>%
  mutate(across(where(is.character), ~ na_if(., "#N/A"))) %>%
  mutate(DepthClass = factor(DepthClass, levels = c("Shallow", "Deep"))) %>%
  mutate(DevelopmentClass = factor(DevelopmentClass, levels = c("Very Low", "Low", "Medium", "High", "Very High"))) %>%
  mutate(SurfaceAreaClass = factor(SurfaceAreaClass, levels = c("Very Small", "Small", "Medium", "Large")))

## define "consistently sampled" ##

allSurface_cont <- allSurface %>%
  group_by(Station.name) %>%
  filter(min(Year) <= 2005,
         max(Year) >= 2016) %>%
  filter(n() >= 9) %>%
  ungroup()

allSurface_pre <- allSurface_cont %>%
  filter(Year <= 2011)

allSurface_post <- allSurface_cont %>%
  filter(Year >= 2012)

# load bottom-only data
allBottom <- read.csv("data/AllPonds_Bottom.csv") %>%
  mutate(across(where(is.character), ~ na_if(., "#N/A"))) %>%
  mutate(DevelopmentClass = factor(DevelopmentClass, levels = c("Very Low", "Low", "Medium", "High", "Very High"))) %>%
  mutate(SurfaceAreaClass = factor(SurfaceAreaClass, levels = c("Very Small", "Small", "Medium", "Large")))

allBottom_cont <- allBottom %>%
  group_by(Station.name) %>%
  filter(min(Year) <= 2005,
         max(Year) >= 2016) %>%
  filter(n() >= 9) %>%
  ungroup()

allBottom_pre <- allBottom_cont %>%
  filter(Year <= 2011)

allBottom_post <- allBottom_cont %>%
  filter(Year >= 2012)
```

## Pt. 1: Summary of new data and data characteristics
```{r}
months <- ponds %>%
  group_by(Station.name, Date) %>%
  summarise(Month = mean(Month))

m <- ggplot(months, aes(x = Month)) +
  geom_histogram(binwidth = 1, fill = "lightblue", col = "black") +
  scale_x_continuous(breaks = c(4:10)) +
  labs(y = "Cumulative sampling events") +
  theme_bw() +
  theme(panel.grid.minor.x = element_blank())

years <- ponds %>%
  group_by(Station.number, Lat, Long) %>%
  summarise(num_years = n_distinct(Year),
            last_year = max(Year))

y <- ggplot(years, aes(x = num_years)) +
  geom_histogram(binwidth = 1, fill = "lightblue", col = "black") +
  labs(x = "Number of years sampled", y = "Number of ponds") +
  theme_bw()

f1a.i <- ggarrange(m, y, ncol = 2)

ggsave("figures/f1a.i.png", f1a, width = 6.5, height = 3, units = "in", dpi = 600)
```

## Pt. 1a cont.

- outline points
- smaller points

```{r}
sf_use_s2(FALSE)

# get Massachusetts outline
mass <- read_sf("/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/gshhg-shp-2.3.7/GSHHS_shp/f/GSHHS_f_L1.shp") %>%
  st_make_valid() %>%
  st_crop(xmin = -71, xmax = -69, ymin = 41, ymax = 42.25)

N <- ggplot() +
  geom_sf(data = mass, fill = "grey60") +
  geom_point(data = years, aes(x = Long, y = Lat, col = num_years)) +
  scale_color_viridis(option = "plasma", name = "N years\nsampled") +
  xlim(-70.65, -69.95) +
  ylim(41.55, 42.07) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())

L <- ggplot() +
  geom_sf(data = mass, fill = "grey60") +
  geom_point(data = years, aes(x = Long, y = Lat, col = last_year)) +
  scale_color_viridis(option = "viridis", name = "Last year\nsampled") +
  xlim(-70.65, -69.95) +
  ylim(41.55, 42.07) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())

f1a.ii <- ggarrange(N, L, ncol = 2)

ggsave("figures/f1a.ii.png", f1a.ii, width = 6.5, height = 3, units = "in", dpi = 600)
```

## Pt. 1a cont.

######
- add missing units
- rotate scale bars

```{r}
params <- c("Secchi", "Chla", "TN", "TP", "Temp", "DO", "Alk")

recent_surf <- allSurface %>%
  group_by(Station.name) %>%
  filter(Year == max(Year))

surf_list <- lapply(params, function(param) {
  ggplot() +
    geom_sf(data = mass, fill = "grey60") +
    geom_point(data = recent_surf[recent_surf[[paste0(param, "_flag")]] == 2, ],
               aes(x = Long, y = Lat, fill = get(param)),
               shape = 21) +
    scale_fill_gradientn(colors = parula(100),
                         limits = c(sort(c(recent_surf[[param]],
                                           recent_bott[[param]]))[1],
                                    sort(c(recent_surf[[param]],
                                           recent_bott[[param]]), decreasing = TRUE)[1]),
                         name = param) +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Surface", param)) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank())
})

recent_bott <- allBottom %>%
  group_by(Station.name) %>%
  filter(Year == max(Year))

bott_list <- lapply(params[3:7], function(param) {
  ggplot() +
    geom_sf(data = mass, fill = "grey60") +
    geom_point(data = recent_bott[recent_bott[[paste0(param, "_flag")]] == 2, ],
               aes(x = Long, y = Lat, fill = get(param)),
               shape = 21) +
    scale_fill_gradientn(colors = parula(100),
                         limits = c(sort(c(recent_surf[[param]],
                                           recent_bott[[param]]))[1],
                                    sort(c(recent_surf[[param]],
                                           recent_bott[[param]]), decreasing = TRUE)[1]),
                         name = param) +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Bottom", param)) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank())
})

surf_list[[2]] <- surf_list[[2]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = "Chl-a (μg/L)")
  
surf_list[[3]] <- surf_list[[3]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = "TN (μM)")

bott_list[[1]] <- bott_list[[1]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = "TN (μM)")

surf_list[[4]] <- surf_list[[4]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = "TP (μM)")

bott_list[[2]] <- bott_list[[2]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = "TP (μM)")

quantile(c(recent_surf$Alk, recent_bott$Alk), probs = c(0.75, 0.9, 0.95, 1), na.rm = TRUE)

surf_list[[7]] <- surf_list[[7]] +
  scale_fill_gradientn(colors = parula(100), limits = c(0, 41), name = "Alkalinity (mg/L)")

bott_list[[5]] <- bott_list[[5]] +
  scale_fill_gradientn(colors = parula(100), limits = c(0, 41), name = "Alkalinity (mg/L)")

f1a.iii <- ggarrange(surf_list[[1]], surf_list[[2]],
                surf_list[[3]], bott_list[[1]],
                surf_list[[4]], bott_list[[2]], ncol = 2)

ggsave("figures/f1a.iii.png", f1a.iii, width = 6.5, height = 7, units = "in", dpi = 600)

f1a.iv <- ggarrange(surf_list[[5]], bott_list[[3]],
          surf_list[[6]], bott_list[[4]],
          surf_list[[7]], bott_list[[5]], ncol = 2)

ggsave("figures/f1a.iv.png", f1a.iv, width = 6.5, height = 7, units = "in", dpi = 600)
```

## Pt. 1b
```{r}
### split time period in half
### put both time periods on same panel; lines instead of filled bars; diff. color for each
### two panels (surface + bottom) per param
### Chla & Secchi on same graphic (both surf panels)

colors <- c("2001-2011" = "dodgerblue", "2012-2023" = "violetred")

Secchi1 <- ggplot(mapping = aes(x = Secchi, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, aes(fill = "2001-2011"), col = NA, alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, aes(fill = "2012-2023"), col = NA, alpha = 0.5, bins = 60) +
  geom_vline(xintercept = 2, linetype = "dashed") +
  geom_vline(xintercept = 4.5, linetype = "dashed") +
  geom_vline(xintercept = -thresh_Secchi, col = "gold") +
  geom_vline(xintercept = -thresh_Secchi_S) +
  labs(x = "Secchi Depth (m)", y = "Proportion", title = "Surface") +
  scale_fill_manual(values = colors) +
  theme_bw() +
  theme(legend.position = c(0.85, 0.8),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.margin = margin(0, 1, 1, 1, "pt"),
        legend.text = element_text(size = 6),
        legend.key.size = unit(0.1, "in"))

Chla1 <- ggplot(mapping = aes(x = log10(Chla), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(1), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_chla), col = "gold") +
  geom_vline(xintercept = log10(thresh_chla_S)) +
  labs(x = "log10(Chl-a) (μg/L)", y = "Proportion", title = "Surface") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN1 <- ggplot(mapping = aes(x = log10(TN), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, binwidth = 0.05) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, binwidth = 0.05) +
  geom_vline(xintercept = log10(11.42), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "gold") +
  geom_vline(xintercept = log10(thresh_TN_S)) +
  xlim(0, 3) +
  ylim(0, 0.125) +
  labs(x = "log10(TN) (μM)", y = "Proportion", title = "Surface") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN2 <- ggplot(mapping = aes(x = log10(TN), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, binwidth = 0.05) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, binwidth = 0.05) +
  geom_vline(xintercept = log10(11.42), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "gold") +
  geom_vline(xintercept = log10(thresh_TN_B)) +
  xlim(0, 3) +
  ylim(0, 0.125) +
  labs(x = "log10(TN) (μM)", y = "Proportion", title = "Bottom") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP1 <- ggplot(mapping = aes(x = log10(TP), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(0.24), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "gold") +
  geom_vline(xintercept = log10(thresh_TP_S)) +
  xlim(-2, 2) +
  ylim(0, 0.105) +
  labs(x = "log10(TP) (μM)", y = "Proportion") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP2 <- ggplot(mapping = aes(x = log10(TP), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(0.24), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "gold") +
  geom_vline(xintercept = log10(thresh_TP_B)) +
  xlim(-2, 2) +
  ylim(0, 0.105) +
  labs(x = "log10(TP) (μM)", y = "Proportion") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp1 <- ggplot(mapping = aes(x = Temp, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(0.5, 30.5) +
  ylim(0, 0.115) +
  labs(x = "Temperature (°C)", y = "Proportion") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp2 <- ggplot(mapping = aes(x = Temp, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(0.5, 30.5) +
  ylim(0, 0.115) +
  labs(x = "Temperature (°C)", y = "Proportion") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO1 <- ggplot(mapping = aes(x = DO, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(-0.25, 14.75) +
  ylim(0, 0.28) +
  labs(x = "DO (mg/L)", y = "Proportion") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO2 <- ggplot(mapping = aes(x = DO, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(-0.25, 14.75) +
  ylim(0, 0.28) +
  labs(x = "DO (mg/L)", y = "Proportion") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

f1 <- ggarrange(Secchi1, Chla1, TN1, TN2, TP1, TP2, Temp1, Temp2, DO1, DO2, ncol = 2)

ggsave("figures/f1.png", f1, width = 6.5, height = 9, units = "in", dpi = 600)
```

## Same as above but density plots
```{r}
hist(na.omit(allSurface_pre$Secchi), prob = TRUE)
lines(density(na.omit(allSurface_pre$Secchi)))

hist(log10(na.omit(allSurface_pre$Secchi)), prob = TRUE)
lines(density(log10(na.omit(allSurface_pre$Secchi))))

colors <- c("2001-2011" = "dodgerblue", "2012-2023" = "violetred")

Secchi1.1 <- ggplot(mapping = aes(x = Secchi)) +
  geom_density(data = allSurface_pre, aes(col = "2001-2011"), alpha = 0.5) +
  geom_density(data = allSurface_post, aes(col = "2012-2023"), alpha = 0.5) +
  geom_vline(xintercept = 2, linetype = "dashed") +
  geom_vline(xintercept = 4.5, linetype = "dashed") +
  geom_vline(xintercept = -thresh_Secchi, col = "darkgoldenrod2") +
  geom_vline(xintercept = -thresh_Secchi_S) +
  labs(x = "Secchi Depth (m)", title = "Surface") +
  scale_color_manual(values = colors) +
  theme_bw() +
  theme(legend.position = c(0.85, 0.8),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.margin = margin(0, 1, 1, 1, "pt"),
        legend.text = element_text(size = 6),
        legend.key.size = unit(0.1, "in"))

Chla1.1 <- ggplot(mapping = aes(x = log10(Chla))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(1), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_chla), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_chla_S)) +
  labs(x = "log10(Chl-a) (μg/L)", title = "Surface") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN1.1 <- ggplot(mapping = aes(x = log10(TN))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(11.42), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TN_S)) +
  xlim(0, 3) +
  ylim(0, 2.05) +
  labs(x = "log10(TN) (μM)", title = "Surface") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN2.1 <- ggplot(mapping = aes(x = log10(TN))) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(11.42), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TN_B)) +
  xlim(0, 3) +
  ylim(0, 2.05) +
  labs(x = "log10(TN) (μM)", title = "Bottom") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP1.1 <- ggplot(mapping = aes(x = log10(TP))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(0.24), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TP_S)) +
  xlim(-2, 2) +
  ylim(0, 1.55) +
  labs(x = "log10(TP) (μM)") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP2.1 <- ggplot(mapping = aes(x = log10(TP))) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(0.24), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TP_B)) +
  xlim(-2, 2) +
  ylim(0, 1.55) +
  labs(x = "log10(TP) (μM)") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp1.1 <- ggplot(mapping = aes(x = Temp)) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  xlim(0.5, 30.5) +
  ylim(0, 0.19) +
  labs(x = "Temperature (°C)") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp2.1 <- ggplot(mapping = aes(x = Temp)) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  xlim(0.5, 30.5) +
  ylim(0, 0.19) +
  labs(x = "Temperature (°C)") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO1.1 <- ggplot(mapping = aes(x = DO)) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(-0.25, 14.75) +
  ylim(0, 0.425) +
  labs(x = "DO (mg/L)") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO2.1 <- ggplot(mapping = aes(x = DO)) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(-0.25, 14.75) +
  ylim(0, 0.425) +
  labs(x = "DO (mg/L)") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

f1.1 <- ggarrange(Secchi1.1, Chla1.1, TN1.1, TN2.1, TP1.1, TP2.1, Temp1.1, Temp2.1, DO1.1, DO2.1, ncol = 2)

ggsave("figures/f1.1.png", f1.1, width = 6.5, height = 9, units = "in", dpi = 600)
```

### Stats for above
```{r}
ks.test(allSurface_pre$Secchi, allSurface_post$Secchi)
ks.test(allSurface_pre$Chla, allSurface_post$Chla)
ks.test(log10(allSurface_pre$Chla), log10(allSurface_post$Chla))
ks.test(allSurface_pre$TN, allSurface_post$TN)
ks.test(log10(allSurface_pre$TN), log10(allSurface_post$TN))
ks.test(allSurface_pre$TP, allSurface_post$TP)
ks.test(log10(allSurface_pre$TP), log10(allSurface_post$TP))
ks.test(allSurface_pre$Temp, allSurface_post$Temp)
ks.test(allSurface_pre$DO, allSurface_post$DO)

ks.test(allBottom_pre$TN, allBottom_post$TN)
ks.test(allBottom_pre$TP, allBottom_post$TP)
ks.test(allBottom_pre$Temp, allBottom_post$Temp)
ks.test(allBottom_pre$DO, allBottom_post$DO)
```

### Pt. 2: Ecoregion thresholds (Secchi, Chla, TN, TP)
Ponds:
-- Hathaway S (BA)
-- Micah (BA)
-- Slough (BR)
-- Pine (BR)
-- Flax (DE)
-- Slough (TR)
-- Duck (WE)
-- Spectacle (WE)

- Calculate 75%ile using allSurface & using ponds; compare
- Calculate 75%ile threshold values per year using ponds

```{r}
ecoregion <- allSurface %>%
  filter(Station.name == "BA-594-01 / Hathaway Pond (South)" |
         Station.name == "BA-797-01 / Micah Pond" |
         Station.name == "BR-321-01 / Slough Pond" |
         Station.name == "BR-335-01 / Pine Pond" |
         Station.name == "DE-355-01 / Flax Pond" |
         Station.name == "TR-53-01 / Slough Pond" |
         Station.name == "WE-76-01 / Duck Pond" |
         Station.name == "WE-64-01 / Spectacle Pond")

ecoregion2 <- ponds %>%
  filter(Month == 8 | Month == 9) %>%
  filter(Station.name == "BA-594-01 / Hathaway Pond (South)" |
         Station.name == "BA-797-01 / Micah Pond" |
         Station.name == "BR-321-01 / Slough Pond" |
         Station.name == "BR-335-01 / Pine Pond" |
         Station.name == "DE-355-01 / Flax Pond" |
         Station.name == "TR-53-01 / Slough Pond" |
         Station.name == "WE-76-01 / Duck Pond" |
         Station.name == "WE-64-01 / Spectacle Pond")

thresh_Secchi <- quantile(-ecoregion$Secchi, na.rm = TRUE)[4]   ### -4.11 vs -4.15
thresh_chla <- quantile(ecoregion$Chla, na.rm = TRUE)[4]   ### 3.06 vs 3.56
thresh_TN <- quantile(ecoregion$TN, na.rm = TRUE)[4]   ### 24.5 vs 23.2
thresh_TP <- quantile(ecoregion$TP, na.rm = TRUE)[4]   ### 0.40 vs 0.45

thresh_Secchi2 <- quantile(-ecoregion2$Secchi, na.rm = TRUE)[4]
thresh_chla2 <- quantile(ecoregion2$Chla, na.rm = TRUE)[4]
thresh_TN2 <- quantile(ecoregion2$TN, na.rm = TRUE)[4]
thresh_TP2 <- quantile(ecoregion2$TP, na.rm = TRUE)[4]

eco_annual <- ecoregion2 %>%
  group_by(Year) %>%
  summarise(Secchi = quantile(Secchi, na.rm = TRUE)[4],
            Chla = quantile(Chla, na.rm = TRUE)[4],
            TN = quantile(TN, na.rm = TRUE)[4],
            TP = quantile(TP, na.rm = TRUE)[4])

# quantile(ecoregion2$Secchi[ecoregion2$Year == 2001], na.rm = TRUE)

m1 <- lm(eco_annual$Secchi ~ eco_annual$Year)
summary(m1)

p1 <- ggplot(eco_annual, aes(x = Year, y = Secchi)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_hline(yintercept = 4.5, linetype = "dashed") +
  geom_hline(yintercept = 2, linetype = "dashed") +
  annotate("text", x = 2004, y = 7.6, label = "slope: 0.01\nP-value: 0.765", col = "blue", size = 3) +
  ylim(0, 8) +
  theme_bw()
  
m2 <- lm(eco_annual$Chla ~ eco_annual$Year)
summary(m2)

p2 <- ggplot(eco_annual, aes(x = Year, y = Chla)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  annotate("text", x = 2004, y = 9, label = "slope: 0.07\nP-value: 0.396", col = "blue", size = 3) +
  scale_y_continuous(limits = c(0, 9.5), breaks = c(0, 2, 4, 6, 8)) +
  theme_bw()

m3 <- lm(eco_annual$TN ~ eco_annual$Year)
summary(m3)

p3 <- ggplot(eco_annual, aes(x = Year, y = TN)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_hline(yintercept = 11.42, linetype = "dashed") +
  annotate("text", x = 2004, y = 43.5, label = "slope: 0.48\nP-value: 0.139", col = "blue", size = 3) +
  ylim(0, 46) +
  theme_bw()

m4 <- lm(eco_annual$TP ~ eco_annual$Year)
summary(m4)

p4 <- ggplot(eco_annual, aes(x = Year, y = TP)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_hline(yintercept = 0.24, linetype = "dashed") +
  annotate("text", x = 2004, y = 0.9, label = "slope: 0.015\nP-value: 0.007", col = "blue", size = 3) +
  ylim(0, 0.95) +
  theme_bw()

f2 <- ggarrange(p1, p2, p3, p4, ncol = 2)

ggsave("figures/f2.png", f2, width = 6.5, height = 5, units = "in", dpi = 600)
```

Questions for Jennie:
- 25%/75% for Secchi -- should be inverted or not? ## negate Secchi

### Use allSurface_cont/allBottom to calc 25th %iles
```{r}
thresh_Secchi_S <- quantile(-allSurface_cont$Secchi, na.rm = TRUE)[2]
thresh_chla_S <- quantile(allSurface_cont$Chla, na.rm = TRUE)[2]
thresh_TN_S <- quantile(allSurface_cont$TN, na.rm = TRUE)[2]
thresh_TP_S <- quantile(allSurface_cont$TP, na.rm = TRUE)[2]

thresh_TN_B <- quantile(allBottom_cont$TN, na.rm = TRUE)[2]
thresh_TP_B <- quantile(allBottom_cont$TP, na.rm = TRUE)[2]
```

### Pt. 4: DO standard
- Calc "recent" (2016+) & annually in table

### 4a
- All ponds on one graphic; hline @ 3 mg/L
```{r}
allBottom_pre %>%
  group_by(Station.name) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 41

length(unique(allBottom_pre$Station.name))  ## 49

allBottom_post %>%
  group_by(Station.name) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 42

length(unique(allBottom_post$Station.name))  ## 49

f3 <- ggplot(mapping = aes(x = Year, y = DO)) +
  geom_point(data = allBottom) +
  geom_point(data = allBottom_pre, col = "firebrick3") +
  geom_point(data = allBottom_post, col = "firebrick3") +
  geom_hline(yintercept = 3, linetype = "dashed") +
  scale_y_continuous(breaks = c(0, 4, 8, 12)) +
  theme_bw()

ggsave("figures/f3.png", f3, width = 5, height = 3.5, units = "in", dpi = 600)

allBottom_pre %>%
  group_by(Station.name) %>%
  filter(Final.Depth > 9) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 24

length(unique(allBottom_pre$Station.name[allBottom_pre$Final.Depth > 9]))  ## 25

allBottom_post %>%
  group_by(Station.name) %>%
  filter(Final.Depth > 9) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 25

length(unique(allBottom_post$Station.name[allBottom_post$Final.Depth > 9]))  ## 25

f4 <- ggplot(mapping = aes(x = Year, y = DO)) +
  geom_point(data = allBottom[allBottom$Final.Depth > 9, ]) +
  geom_point(data = allBottom_pre[allBottom_pre$Final.Depth > 9, ], col = "firebrick3") +
  geom_point(data = allBottom_post[allBottom_post$Final.Depth > 9, ], col = "firebrick3") +
  geom_hline(yintercept = 3, linetype = "dashed") +
  scale_y_continuous(limits = c(0, 12.25), breaks = c(0, 4, 8, 12)) +
  theme_bw()

ggsave("figures/f4.png", f4, width = 5, height = 3.5, units = "in", dpi = 600)
```

### 4c (Maps w/ trends in all parameters)

######
- add units (e.g. mg/L/yr)

```{r}
params <- c("Secchi", "Chla", "TN", "TP", "Temp", "DO", "Alk")

surf_list2 <- lapply(params, function(param) {
  ggplot() +
    geom_sf(data = mass, fill = "grey60") +
    geom_point(data = slopes_surf2[!is.na(slopes_surf2[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), col = factor(sign(get(param)))),
               shape = 21) +
    geom_point(data = slopes_surf[!is.na(slopes_surf[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), fill = factor(sign(get(param)))),
               shape = 21) +
    scale_size_continuous(range = c(1, 4),
                          limits = c(sort(abs(c(slopes_surf[[param]],
                                                slopes_surf2[[param]],
                                                slopes_bott[[param]],
                                                slopes_bott2[[param]])))[1],
                                     sort(abs(c(slopes_surf[[param]],
                                                slopes_surf2[[param]],
                                                slopes_bott[[param]],
                                                slopes_bott2[[param]])), decreasing = TRUE)[1]),
                          name = "Trend\nmagnitude") +
    # scale_color_gradientn(colors = c("royalblue3", "royalblue2", "white", "firebrick", "firebrick4"),
    #                       na.value = NA,
    #                       limits = c(-sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4],
    #                                 sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4]),
    #                       name = "Trend") +
    # scale_fill_gradientn(colors = c("royalblue3", "royalblue2", "white", "firebrick", "firebrick4"),
    #                      na.value = NA,
    #                      limits = c(-sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4],
    #                                 sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4]),
    #                      name = "Trend") +
    scale_color_manual(values = c("royalblue", "black", "firebrick"),
                       breaks = c(-1, 0, 1),
                       labels = c("negative", "zero", "positive"),
                       name = "Trend\ndirection",
                       na.translate = FALSE,
                       guide = "none") +
    scale_fill_manual(values = c("royalblue", "firebrick"),
                      breaks = c(-1, 1),
                      labels = c("negative", "positive"),
                      name = "Trend\ndirection",
                      na.translate = FALSE,
                      guide = "none") +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Surface", param)) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank())
})

bott_list2 <- lapply(params[3:7], function(param) {
  ggplot() +
    geom_sf(data = mass, fill = "grey60") +
    geom_point(data = slopes_bott2[!is.na(slopes_bott2[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), col = factor(sign(get(param)))),
               shape = 21) +
    geom_point(data = slopes_bott[!is.na(slopes_bott[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), fill = factor(sign(get(param)))),
               shape = 21) +
    scale_size_continuous(range = c(1, 4), name = "Trend\nmagnitude") +
    # scale_color_gradientn(colors = c("royalblue3", "royalblue2", "white", "firebrick", "firebrick4"),
    #                       na.value = NA,
    #                       limits = c(-sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4],
    #                                 sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4]),
    #                       name = "Trend") +
    # scale_fill_gradientn(colors = c("royalblue3", "royalblue2", "white", "firebrick", "firebrick4"),
    #                      na.value = NA,
    #                      limits = c(-sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4],
    #                                 sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4]),
    #                      name = "Trend") +
    scale_color_manual(values = c("royalblue", "black", "firebrick"),
                       breaks = c(-1, 0, 1),
                       labels = c("negative", "zero", "positive"),
                       name = "Trend\ndirection",
                       na.translate = FALSE,
                       guide = "none") +
    scale_fill_manual(values = c("royalblue", "firebrick"),
                      breaks = c(-1, 1),
                      labels = c("negative", "positive"),
                      name = "Trend\ndirection",
                      na.translate = FALSE,
                      guide = "none") +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Bottom", param)) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank())
})

# surf_list2[[3]] <- surf_list2[[3]] +
#   scale_size_continuous(limits = c(0, 5.5), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[1]] <- bott_list2[[1]] +
#   scale_size_continuous(limits = c(0, 5.5), range = c(1, 4), name = "Trend\nmagnitude")
# 
# surf_list2[[4]] <- surf_list2[[4]] +
#   scale_size_continuous(limits = c(0, 0.4), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[2]] <- bott_list2[[2]] +
#   scale_size_continuous(limits = c(0, 0.4), range = c(1, 4), name = "Trend\nmagnitude")
# 
# surf_list2[[5]] <- surf_list2[[5]] +
#   scale_size_continuous(limits = c(0, 0.8), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[3]] <- bott_list2[[3]] +
#   scale_size_continuous(limits = c(0, 0.8), range = c(1, 4), name = "Trend\nmagnitude")
# 
# surf_list2[[6]] <- surf_list2[[6]] +
#   scale_size_continuous(limits = c(0, 0.65), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[4]] <- bott_list2[[4]] +
#   scale_size_continuous(limits = c(0, 0.65), range = c(1, 4), name = "Trend\nmagnitude")
# 
# surf_list2[[7]] <- surf_list2[[7]] +
#   scale_size_continuous(limits = c(0, 4.5), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[5]] <- bott_list2[[5]] +
#   scale_size_continuous(limits = c(0, 4.5), range = c(1, 4), name = "Trend\nmagnitude")

f5 <- ggarrange(surf_list2[[1]], surf_list2[[2]],
                surf_list2[[3]], bott_list2[[1]],
                surf_list2[[4]], bott_list2[[2]], ncol = 2)

ggsave("figures/f5.1.png", f5, width = 6.5, height = 7, units = "in", dpi = 600)

f6 <- ggarrange(surf_list2[[5]], bott_list2[[3]],
          surf_list2[[6]], bott_list2[[4]],
          surf_list2[[7]], bott_list2[[5]], ncol = 2)

ggsave("figures/f6.1.png", f6, width = 6.5, height = 7, units = "in", dpi = 600)
```
