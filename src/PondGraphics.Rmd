---
title: "PondGraphics"
author: "Dylan Titmuss"
date: "2023-12-26"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Load packages
```{r include = FALSE}
### Load packages

library(tidyverse)
library(gsw)
library(trend)
library(egg)
library(DT)
library(pals)
library(sf)
library(cowplot)
library(rkt)
```

### Load data
```{r include = FALSE}
### Load data

setwd("~/Desktop/Repos/CapeCodPonds2023")

#ponds_full <- read.csv("data/072523_CC_AllPonds_WQ.csv", header = TRUE) %>%
#ponds_full <- read.csv("data/09132023_CC_AllPonds_WQ.csv", header = TRUE) %>%
#ponds_full <- read.csv("data/11032023_CC_AllPonds_WQ.csv", header = TRUE) %>%
#ponds_full <- read.csv("data/12142023_CC_AllPonds_WQ.csv", header = TRUE) %>%
ponds_full <- read.delim("data/03182024_CC_AllPonds_WQ.txt", header = TRUE) %>%
  
  # remove non-data rows
  filter(Station.name != "" & Station.name != " ")
```

```{r include = FALSE}
ponds <- ponds_full

# remove WISKI-designated outliers
for(qc in colnames(ponds %>% select(contains("Quality.code")))) {
  index <- match(qc, colnames(ponds))
  ponds[[index - 1]] <- if_else(ponds[[qc]] == "Pond - Outlier",
                               "",
                               ponds[[index - 1]],
                               missing = ponds[[index - 1]])
}

ponds <- ponds %>%
  # merge same-parameter columns & reorganize data frame
  unite(Alk, Alkalinity...ALK, Alkalinity...ALK.1, sep = "") %>%
  unite(Chla, Chlorophyll...CHLA, Chlorophyll...CHLA.1, sep = "") %>%
  unite(DO, Dissolved.Oxygen...Reported...DO, Dissolved.Oxygen...Reported...DO.1,
        Dissolved.Oxygen...Reported...DO.2, sep = "") %>%
  unite(DO_sat, Dissolved.Oxygen.Saturation...Reported...DO_SAT,
        Dissolved.Oxygen.Saturation...Reported...DO_SAT.1, sep = "") %>%
  unite(pH, pH...PH, pH...PH.1, pH...PH.2, sep = "") %>%
  unite(Phaeo, Phaeophytin...PHAEO, Phaeophytin...PHAEO.1, sep = "") %>%
  unite(Sal, Salinity...SAL, Salinity...SAL.1, sep = "") %>%
  unite(Secchi, Secchi.Depth...SECCHI, Secchi.Depth...SECCHI.1,
        Secchi.Depth...SECCHI.2, sep = "") %>%
  unite(TN_uM, Total.Nitrogen...Reported...TN, Total.Nitrogen...Reported...TN.1, sep = "") %>%
  unite(TP_uM, Total.Phosphorus...TP, Total.Phosphorus...TP.1, sep = "") %>%
  unite(Temp, Water.Temperature...TEMP, Water.Temperature...TEMP.1,
        Water.Temperature...TEMP.2, sep = "") %>%
  
  # split long/lat coordinates
  separate_wider_delim(Long.lat.coordinates, " / ", names = c("Long", "Lat"), too_few = "align_start") %>%
  
  # rename columns with redundant headers
  rename(CTI_TP = Carlson.Trophic.Index...Total.Phosphorus.based...CTI_TP,
         CTI_Chlorophyll = Carlson.Trophic.Index...Chlorophyll.a.based...CTI_CHLA,
         CTI_Secchi = Carlson.Trophic.Index...Secchi.Depth.Based...CTI_SD,
         Total.Depth = Total.Depth...DTB,
         TP = Total.Phosphorus...micrograms.per.liter...TP_ugL) %>%
  
  # reorder columns
  relocate(Total.Depth, .before = Depth) %>%
  relocate(Secchi, .after = Depth) %>%
  relocate(Temp, .after = Secchi) %>%
  relocate(DO, .after = Temp) %>%
  relocate(DO_sat, .after = DO) %>%
  relocate(Alk, .after = DO_sat) %>%
  relocate(TP, .after = Alk) %>%
  relocate(Chla, .after = TP) %>%
  relocate(TN_uM, .after = Chla) %>%
  relocate(TP_uM, .after = TN_uM) %>%
  
  # extract date, month, year from date-time column & create new column
  mutate(Date = str_extract(Date.Time..sampling., "\\d+/\\d+/\\d+"),
         Time = str_extract(Date.Time..sampling., "\\d{1,2}:\\d{2}"),
         Month = str_extract(Date, "\\d{1,2}(?=/)"),
         #Year = paste("20", str_extract(Date, "(?<=\\d{1,2}/\\d{1,2}/)\\d+"), sep = ""),
         ## use this^ if WISKI output has M/D/YY format; use line below if output has M/D/YYYY format
         Year = str_extract(Date, "(?<=\\d{1,2}/\\d{1,2}/)\\d+"),
         Year_frac = as.numeric(Year) + as.numeric(Month)/12) %>%
  
  # note last year sampled for later reference
  group_by(Station.name) %>%
  mutate(Last_year = max(Year)) %>%
  ungroup() %>%
  
  # prepare columns for reordering ponds in dropdown menu
  mutate(Town = str_extract(Station.name, "[A-Z]{2}")) %>%
  mutate(Station = str_extract(Station.name, ".+(?= /)")) %>%
  mutate(Station.name = paste0(Town, " / ", Station, " (", Station.number, ")"))

# convert all empty cells to NA
ponds[ponds == ""] <- NA

# fix non-numeric characters

# nm <- ponds %>%
#   select(-contains("Quality.code"), -Sample.number, -Depth.Designation) %>%
#   select(c(which(colnames(.) == "Total.Depth") : (which(colnames(.) == "Date") - 1))) %>%
#   filter(if_any(everything(), ~ str_detect(., "[:alpha:]|<|>")))
# 
# sort(unique(unlist(nm)[!is.na(str_extract(unlist(nm), "[:alpha:]|<|>"))]))   ### use this to identify problem vals

ponds[ponds == "< 0.05"] <- "0"
ponds[ponds == "< 0.10"] <- "0"
ponds[ponds == "< 1.00"] <- "1.00"
ponds[ponds == "< 1.50"] <- "1.50"
ponds[ponds == "> 15.50"] <- "15.50"

ponds[ponds == "BDL 0.00"] <- "0"
ponds[ponds == "<MDL 0.00"] <- NA
ponds[ponds == "n.m. 0.00"] <- NA
ponds[ponds == "ND 0.00"] <- NA

ponds[ponds == "n.m. 0.03"] <- "0.03"
ponds[ponds == "n.m. 1.37"] <- "1.37"
ponds[ponds == "n.m. 6.83"] <- "6.83"
ponds[ponds == "n.m. 13.96"] <- "13.96"
ponds[ponds == "n.m. 13.98"] <- "13.98"
ponds[ponds == "n.m. 19.90"] <- "19.90"
ponds[ponds == "n.m. 30.81"] <- "30.81"

# convert all numerical cols to numeric
is_all_numeric <- function(x) {
  !any(is.na(suppressWarnings(as.numeric(na.omit(x))))) & is.character(x)
}
not_all_na <- function(x) any(!is.na(x))
ponds <- ponds %>% 
  mutate_if(is_all_numeric, as.numeric) %>%
  select(where(not_all_na))

#str(ponds)

# fix inappropriately negative characters

# neg <- ponds %>%
#   select(where(is.numeric), -contains(c("Long", "CTI", "ORP"))) %>%
#   filter(if_any(everything(), ~ str_detect(., "-")))
# 
# sort(unique(unlist(neg)[!is.na(str_extract(unlist(neg), "-"))]))

ponds[ponds == -0.04] <- 0.04
ponds[ponds == -0.15] <- 0.15
ponds[ponds == -0.3] <- 0.3

# fix erroneous values
ponds$DO[ponds$Station.name == "HA-353-01 / Hinckleys Pond" &
         ponds$DO == 0.84] <- NA
ponds$DO_sat[ponds$Station.name == "HA-353-01 / Hinckleys Pond" &
             ponds$DO_sat == 121.12] <- NA

# copy Secchi values to all rows (esp. from rows with NA depth)
for(i in 1:nrow(ponds)) {
  if(!is.na(ponds$Secchi[i])) {
    ponds$Secchi[ponds$Station.name == ponds$Station.name[i] & ponds$Date == ponds$Date[i]] <-
      mean(ponds$Secchi[ponds$Station.name == ponds$Station.name[i] & ponds$Date == ponds$Date[i]], na.rm = TRUE)
  }
}

ponds <- ponds %>%
  group_by(Station.name, Date) %>%
  mutate(Secchi = mean(Secchi, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Secchi = ifelse(is.nan(Secchi), NA, Secchi))
```

```{r include = FALSE}
# calculate DO saturation values (*in future should come from WISKI)
for(i in 1:nrow(ponds)) {
  if(is.na(ponds$DO_sat[i])) {
    rho <- gsw_rho(0, ponds$Temp[i], ponds$Depth[i]) # kg/m^3
    ponds$DO_sat[i] <- ponds$DO[i] / 31.999 / rho * 10^6 /
                        gsw_O2sol(0, ponds$Temp[i], ponds$Depth[i], ponds$Long[i], ponds$Lat[i]) * 100
  }
  if(is.na(ponds$DO[i])) {
    rho <- gsw_rho(0, ponds$Temp[i], ponds$Depth[i]) # kg/m^3
    ponds$DO[i] <- gsw_O2sol(0, ponds$Temp[i], ponds$Depth[i], ponds$Long[i], ponds$Lat[i]) / 100 *
                    ponds$DO_sat[i] * 31.999 * rho / 10^6
  }
  if(!is.na(ponds$DO[i]) & !is.na(ponds$DO_sat[i]) &
     ponds$DO[i] == 0 & ponds$DO_sat[i] > 0) {
    rho <- gsw_rho(0, ponds$Temp[i], ponds$Depth[i]) # kg/m^3
    ponds$DO[i] <- gsw_O2sol(0, ponds$Temp[i], ponds$Depth[i], ponds$Long[i], ponds$Lat[i]) / 100 *
                    ponds$DO_sat[i] * 31.999 * rho / 10^6
  }
}

#mg/L to um/kg
#mg/L * 1000L/m^3 = mg/m^3 * 1g/1000mg = g/m^3 * 1mol/31.999g = mol/m^3 * 1/rho m^3/kg = mol/kg * 1,000,000 umol/mol


# convert uM to ug/L
ponds$TN <- ponds$TN_uM * 14.0067
ponds$TP <- ifelse(!is.na(ponds$TP), ponds$TP, ponds$TP_uM * 30.973762)

ponds <- ponds %>%
  relocate(TN, .before = TP)

# uM = umol/L * mol/10^6umol = mol/10^6L * Xg/mol = g/10^6L * 10^6ug/g = ug/L
```

```{r include = FALSE}
# calculate MLDs
ponds$MLD <- NA
ponds$Max.Depth <- NA

allPonds <- unique(ponds$Station.name)

for(pond in allPonds) {
  onePond <- ponds[ponds$Station.name == pond, ] %>%
    arrange(Date, Depth)
  
  # create full-depth column
  ponds$Max.Depth[ponds$Station.name == pond] <- max(onePond$Depth, na.rm = TRUE)
  
  if(max(onePond$Depth, na.rm = TRUE) < 5) {
    next
  }
  
  for(d in unique(onePond$Date)) {
    oneDate <- onePond[onePond$Date == d &
                       (onePond$Month == 8 |      # delete this + next line to evaluate MLD in all months
                        onePond$Month == 9) &     # note that doing this^^ will mess up MLD trend plots
                       !is.na(onePond$Depth), ]
    if(sum(!is.na(oneDate$Temp)) < 2 | n_distinct(oneDate$Depth[oneDate$Depth > 1]) < 2) {  # can MLD == 1??
      next
    }
    for(i in 1:(n_distinct(oneDate$Depth) - 1)) {
      if(is.na(oneDate$Temp[i]) | oneDate$Depth[i] <= 1) {
        next
      }
      j <- i + 1
      while(j < n_distinct(oneDate$Depth)) {
        if(!is.na(oneDate$Temp[j])) {
          break
        } else {
          j <- j + 1
        }
      }
      if(is.na(oneDate$Temp[j])) {
        break
      }
      depth_diff <- oneDate$Depth[j] - oneDate$Depth[i]
      temp_diff <- oneDate$Temp[j] - oneDate$Temp[i]
      delta_temp <- temp_diff / depth_diff
      if(delta_temp < -1) {
        ponds$MLD[ponds$Station.name == pond &
                  ponds$Date == d &
                  (ponds$Month == 8 |
                   ponds$Month == 9)] <- oneDate$Depth[i]
        break
      }
    }
    if(delta_temp >= -1) {
      ponds$MLD[ponds$Station.name == pond &
                ponds$Date == d &
                (ponds$Month == 8 |
                 ponds$Month == 9)] <- oneDate$Depth[j]
    }
  }
}

ponds <- ponds %>%
  relocate(Max.Depth, .before = Depth) %>%
  relocate(MLD, .before = Temp)
```

```{r include = FALSE}
# match ponds to metadata
setwd("~/Desktop/Repos/CapeCodPonds2023")

chars <- read.csv("data/PondCharacteristics.csv") %>%
  mutate(across(where(is.character), ~ na_if(., "#N/A")))

ponds$Size <- NA
ponds$Lens <- NA
ponds$PercentDeveloped <- NA
ponds$Char.Depth.ft <- NA

for(i in 1:nrow(ponds)) {
  ID <- str_extract(ponds$Station.number[i], "[A-Z]{2}-\\d+")
  if(length(chars$Acres[chars$CCC_GIS_ID == ID]) > 0) {
    ponds$Size[i] <- as.numeric(chars$Acres[chars$CCC_GIS_ID == ID])
    ponds$Lens[i] <- chars$Aquifer.Lens[chars$CCC_GIS_ID == ID]
    ponds$PercentDeveloped[i] <- chars$X..100ft.buffer.developed[chars$CCC_GIS_ID == ID]
    ponds$Char.Depth.ft[i] <- as.numeric(chars$Final.Depth[chars$CCC_GIS_ID == ID])
  }
}

ponds <- ponds %>%
  mutate(Char.Depth = Char.Depth.ft * 0.3048) %>%
  relocate(Char.Depth, .before = Max.Depth)

ponds <- ponds %>%
  mutate(DepthClass = case_when(Max.Depth <= 3 ~ "Shallow",
                                Max.Depth > 3 ~ "Deep"))

ponds$SurfaceAreaClass <- NA

# ponds_grouped <- ponds %>%
#   group_by(Station.name) %>%
#   summarize(Size = Size[1])
# 
# quantile(ponds_grouped$Size, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)

ponds$SurfaceAreaClass <- case_when(ponds$Size <= 5.743542 ~ "Very Small",
                                    ponds$Size <= 12.315432 ~ "Small",
                                    ponds$Size <= 32.563650 ~ "Medium",
                                    ponds$Size > 32.563650 ~ "Large")

ponds$PercentDeveloped <- as.numeric(str_extract(ponds$PercentDeveloped, ".*(?=%)"))

# ponds_grouped <- ponds %>%
#   group_by(Station.name) %>%
#   summarize(PercentDeveloped = PercentDeveloped[1])
# 
# quantile(ponds_grouped$PercentDeveloped, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)

ponds <- ponds %>%
  mutate(DevelopmentClass = case_when(ponds$PercentDeveloped <= 5.00 ~ "Very Low",
                                      ponds$PercentDeveloped <= 13.00 ~ "Low",
                                      ponds$PercentDeveloped <= 23.25 ~ "Medium",
                                      ponds$PercentDeveloped > 23.25 ~ "High"))
```

### Pt. 1: Summary of new data and data characteristics
```{r}
months <- ponds %>%
  group_by(Station.name, Date) %>%
  summarise(Month = Month[1])

mo <- ggplot(months, aes(x = Month)) +
  geom_histogram(binwidth = 1, fill = "lightblue", col = "black") +
  scale_x_continuous(breaks = c(min(months$Month, na.rm = TRUE):max(months$Month, na.rm = TRUE))) +
  labs(y = "Cumulative sampling events") +
  theme_classic() +
  theme(panel.grid.minor.x = element_blank())

years <- ponds %>%
  group_by(Station.name, Lat, Long) %>%
  summarise(num_years = n_distinct(Year),
            last_year = max(Year))

ye <- ggplot(years, aes(x = num_years)) +
  geom_histogram(binwidth = 1, fill = "lightblue", col = "black") +
  labs(x = "Number of years sampled", y = "Number of ponds") +
  theme_classic()

f1a.i <- ggarrange(ye, mo, ncol = 2)

ggsave("figures/f1a.i.png", f1a.i, width = 6.5, height = 3, units = "in", dpi = 600)

pie <- years %>%
  mutate(bin = case_when(num_years <= 5 ~ "[1,5]",
                         num_years > 5 & num_years <= 10 ~ "(5,10]",
                         num_years > 10 & num_years <= 15 ~ "(10,15]",
                         num_years > 15 ~ "> 15")) %>%
  group_by(bin) %>%
  summarise(n = n())

f1a.i2 <- ggplot(pie, aes(x = "", y = n, fill = factor(bin, levels = c("[1,5]", "(5,10]", "(10,15]", "> 15")))) +
  geom_bar(width = 1, stat = "identity", col = "black") +
  coord_polar("y", start = 0, direction = -1) +
  geom_text(aes(label = paste0(n, "\n(", percent(n/sum(n)), ")")),
            position = position_stack(vjust = 0.5), size = 3) +
  labs(fill = "Number of\nyears sampled") +
  theme_classic() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank())

ggsave("figures/f1a.i2.png", f1a.i2, width = 4.5, height = 3, units = "in", dpi = 600)
```

### Pt. 1a cont.
```{r}
sf_use_s2(FALSE)

# get Massachusetts outline
mass <- read_sf("/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/gshhg-shp-2.3.7/GSHHS_shp/f/GSHHS_f_L1.shp") %>%
  st_make_valid() %>%
  st_crop(xmin = -71, xmax = -69, ymin = 41, ymax = 42.25)

years <- years %>%
  arrange(desc(num_years))

N <- ggplot() +
  geom_sf(data = mass) +
  geom_point(data = years, aes(x = Long, y = Lat, fill = num_years),
             shape = 21, size = 1.25, stroke = 0.25) +
  scale_fill_viridis(option = "plasma", name = "N years\nsampled") +
  xlim(-70.65, -69.95) +
  ylim(41.55, 42.07) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())

years <- years %>%
  arrange(desc(last_year))

L <- ggplot() +
  geom_sf(data = mass) +
  geom_point(data = years, aes(x = Long, y = Lat, fill = last_year),
             shape = 21, size = 1.25, stroke = 0.25) +
  scale_fill_viridis(option = "viridis", name = "Last year\nsampled") +
  xlim(-70.65, -69.95) +
  ylim(41.55, 42.07) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())

f1a.ii <- ggarrange(N, L, ncol = 2)

ggsave("figures/f1a.ii.png", f1a.ii, width = 6.5, height = 3, units = "in", dpi = 600, bg = "white")
```

### Load layer-specific data
```{r}
setwd("~/Desktop/Repos/CapeCodPonds2023")

# load surface-only data
allSurface <- read.csv("data/AllPonds_Surface.csv") %>%
  #mutate(across(where(is.character), ~ na_if(., "#N/A"))) %>%
  mutate(DepthClass = factor(DepthClass, levels = c("Shallow", "Deep"))) %>%
  mutate(DevelopmentClass = factor(DevelopmentClass, levels = c("Very Low", "Low", "Medium", "High", "Very High"))) %>%
  mutate(SurfaceAreaClass = factor(SurfaceAreaClass, levels = c("Very Small", "Small", "Medium", "Large")))

## define "consistently sampled" ##

allSurface_cont <- allSurface %>%
  group_by(Station.name) %>%
  filter(min(Year) <= quantile(2001:2023)[2],
         max(Year) >= quantile(2001:2023)[4]) %>%
  filter(n() >= (2023 - 2001)/2) %>%
  ungroup()

allSurface_pre <- allSurface_cont %>%
  filter(Year <= 2011)                    # change if desired

allSurface_post <- allSurface_cont %>%
  filter(Year >= 2012)                    # change if desired

# load bottom-only data
allBottom <- read.csv("data/AllPonds_Bottom.csv") %>%
  #mutate(across(where(is.character), ~ na_if(., "#N/A"))) %>%
  mutate(DevelopmentClass = factor(DevelopmentClass, levels = c("Very Low", "Low", "Medium", "High", "Very High"))) %>%
  mutate(SurfaceAreaClass = factor(SurfaceAreaClass, levels = c("Very Small", "Small", "Medium", "Large")))

allBottom_cont <- allBottom %>%
  group_by(Station.name) %>%
  filter(min(Year) <= quantile(2001:2023)[2],
         max(Year) >= quantile(2001:2023)[4]) %>%
  filter(n() >= (2023 - 2001)/2) %>%
  ungroup()

allBottom_pre <- allBottom_cont %>%
  filter(Year <= 2011)                    # change if desired

allBottom_post <- allBottom_cont %>%
  filter(Year >= 2012)                    # change if desired
```

### Pt. 1a cont.

######
- rotate scale bars

```{r}
params <- c("Secchi", "MLD", "TN", "TP", "NtP", "Chla", "Temp", "DO", "DO_sat", "Alk")

# function for dealing with log10(0)
zero_sub <- function(x) {
  str <- strsplit(as.character(x), ".", fixed = TRUE)[[1]]
  if(str[1] != 0) {
    exp <- str_count(str[1], "0")
    return(10^exp)
  } else {
    exp <- str_count(str[2], "0") + 1
    return(10^-exp)
  }
}

recent_surf <- allSurface %>%
  group_by(Station.name) %>%
  filter(Year == max(Year)) %>%
  ungroup() %>%
  mutate(TN = if_else(TN == 0, zero_sub(sort(unique(recent_surf$TN))[2]), TN),
         TP = if_else(TP == 0, zero_sub(sort(unique(recent_surf$TP))[2]), TP),
         Chla = if_else(Chla == 0, zero_sub(sort(unique(recent_surf$Chla))[2]), Chla))

recent_bott <- allBottom %>%
  group_by(Station.name) %>%
  filter(Year == max(Year)) %>%
  ungroup() %>%
  mutate(TN = if_else(TN == 0, zero_sub(sort(unique(recent_bott$TN))[2]), TN),
         TP = if_else(TP == 0, zero_sub(sort(unique(recent_bott$TP))[2]), TP),
         Chla = if_else(Chla == 0, zero_sub(sort(unique(recent_bott$Chla))[2]), Chla))

surf_list <- lapply(params, function(param) {
  ggplot() +
    geom_sf(data = mass) +
    geom_point(data = recent_surf[recent_surf[[paste0(param, "_flag")]] == 2, ],
               aes(x = Long, y = Lat, fill = get(param)),
               shape = 21) +
    scale_fill_gradientn(colors = parula(100),
                         limits = c(min(c(recent_surf[[param]],
                                          recent_bott[[param]]), na.rm = TRUE),
                                    max(c(recent_surf[[param]],
                                          recent_bott[[param]]), na.rm = TRUE)),
                         name = param) +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Surface")) +
    theme_classic() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank())
})

bott_list <- lapply(params[c(3:4, 7:10)], function(param) {
  ggplot() +
    geom_sf(data = mass) +
    geom_point(data = recent_bott[recent_bott[[paste0(param, "_flag")]] == 2, ],
               aes(x = Long, y = Lat, fill = get(param)),
               shape = 21) +
    scale_fill_gradientn(colors = parula(100),
                         limits = c(min(c(recent_surf[[param]],
                                          recent_bott[[param]]), na.rm = TRUE),
                                    max(c(recent_surf[[param]],
                                          recent_bott[[param]]), na.rm = TRUE)),
                         name = param) +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Bottom")) +
    theme_classic() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank())
})

surf_list[[1]] <- surf_list[[1]] +
  scale_fill_gradientn(colors = parula(100), name = "Secchi\ndepth (m)") +
  labs(title = "")

surf_list[[2]] <- surf_list[[2]] +
  scale_fill_gradientn(colors = parula(100), name = "Mixed-layer\ndepth (m)") +     # not working inside `labs()`
  labs(title = "")

surf_list[[3]] <- surf_list[[3]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = expression("TN (μg L"^-1*")"),
                       limits = c(min(c(recent_surf$TN,
                                        recent_bott$TN), na.rm = TRUE),
                                  max(c(recent_surf$TN,
                                        recent_bott$TN), na.rm = TRUE)))

bott_list[[1]] <- bott_list[[1]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = expression("TN (μg L"^-1*")"),
                       limits = c(min(c(recent_surf$TN,
                                        recent_bott$TN), na.rm = TRUE),
                                  max(c(recent_surf$TN,
                                        recent_bott$TN), na.rm = TRUE)))

surf_list[[4]] <- surf_list[[4]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = expression("TP (μg L"^-1*")"),
                       limits = c(min(c(recent_surf$TP,
                                        recent_bott$TP), na.rm = TRUE),
                                  max(c(recent_surf$TP,
                                        recent_bott$TP), na.rm = TRUE)))

bott_list[[2]] <- bott_list[[2]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = expression("TP (μg L"^-1*")"),
                       limits = c(min(c(recent_surf$TP,
                                        recent_bott$TP), na.rm = TRUE),
                                  max(c(recent_surf$TP,
                                        recent_bott$TP), na.rm = TRUE)))

# ggplot(recent_surf, aes(NtP)) + geom_histogram()  ## not really log-distributed

# quantile(recent_surf$NtP, probs = c(0.9, 0.95, 0.975, 1), na.rm = TRUE)
# min(c(recent_surf$NtP, recent_bott$NtP), na.rm = TRUE)

top <- 130   # upper bound of color scale

surf_list[[5]] <- surf_list[[5]] +
  geom_point(data = recent_surf[recent_surf[["NtP"]] < 16, ],   ### this puts N-limited ponds on top
             aes(x = Long, y = Lat, fill = NtP),
             shape = 21) +
  scale_fill_gradientn(colors = c("firebrick4", "firebrick2", parula(11)), name = "N:P",
                       limits = c(0.01, top),
                       values = rescale(c(0, (16 - 0.000000000000001),
                                          16, 16 + ((top-16)/10) * (1:10))),
                       breaks = c(16, 50, 100, 150),
                       na.value = "#F9FB0E")

surf_list[[6]] <- surf_list[[6]] +
  scale_fill_gradientn(colors = parula(100), trans = "log10", name = expression("Chl-a (μg L"^-1*")"))

surf_list[[7]] <- surf_list[[7]] +
  scale_fill_gradientn(colors = parula(100), name = "Temp (°C)",
                       limits = c(min(c(recent_surf$Temp,
                                        recent_bott$Temp), na.rm = TRUE),
                                  max(c(recent_surf$Temp,
                                        recent_bott$Temp), na.rm = TRUE)))

bott_list[[3]] <- bott_list[[3]] +
  scale_fill_gradientn(colors = parula(100), name = "Temp (°C)",
                       limits = c(min(c(recent_surf$Temp,
                                        recent_bott$Temp), na.rm = TRUE),
                                  max(c(recent_surf$Temp,
                                        recent_bott$Temp), na.rm = TRUE)))

surf_list[[8]] <- surf_list[[8]] +
  scale_fill_gradientn(colors = c("firebrick2", "white", "white", "#0D77DA"), expression("DO (mg L"^-1*")"),
                       limits = c(min(c(recent_surf$DO,
                                        recent_bott$DO), na.rm = TRUE),
                                  max(c(recent_surf$DO,
                                        recent_bott$DO), na.rm = TRUE)),
                       values = rescale(c(min(c(recent_surf$DO,
                                                recent_bott$DO), na.rm = TRUE),
                                          (3 - 0.000000000000001), 3,
                                          max(c(recent_surf$DO,
                                                recent_bott$DO), na.rm = TRUE))))

bott_list[[4]] <- bott_list[[4]] +
  scale_fill_gradientn(colors = c("firebrick2", "white", "white", "#0D77DA"), expression("DO (mg L"^-1*")"),
                       limits = c(min(c(recent_surf$DO,
                                        recent_bott$DO), na.rm = TRUE),
                                  max(c(recent_surf$DO,
                                        recent_bott$DO), na.rm = TRUE)),
                       values = rescale(c(min(c(recent_surf$DO,
                                                recent_bott$DO), na.rm = TRUE),
                                          (3 - 0.000000000000001), 3,
                                          max(c(recent_surf$DO,
                                                recent_bott$DO), na.rm = TRUE))))

surf_list[[9]] <- surf_list[[9]] +
  scale_fill_gradientn(colors = parula(100), name = "DO sat. (%)",
                       limits = c(min(c(recent_surf$DO_sat,
                                        recent_bott$DO_sat), na.rm = TRUE),
                                  max(c(recent_surf$DO_sat,
                                        recent_bott$DO_sat), na.rm = TRUE)))

bott_list[[5]] <- bott_list[[5]] +
  scale_fill_gradientn(colors = parula(100), name = "DO sat. (%)",
                       limits = c(min(c(recent_surf$DO_sat,
                                        recent_bott$DO_sat), na.rm = TRUE),
                                  max(c(recent_surf$DO_sat,
                                        recent_bott$DO_sat), na.rm = TRUE)))

# quantile(c(recent_surf$Alk, recent_bott$Alk), probs = c(0.9, 0.95, 0.975, 1), na.rm = TRUE)
# min(c(recent_surf$Alk, recent_bott$Alk), na.rm = TRUE)

top <- 60   # upper bound of color scale

surf_list[[10]] <- surf_list[[10]] +
  scale_fill_gradientn(colors = parula(100), limits = c(0, top),
                       breaks = c(20, 40, 60),
                       name = expression("Alk (mg L"^-1*")"),
                       na.value = "#F9FB0E")

bott_list[[6]] <- bott_list[[6]] +
  scale_fill_gradientn(colors = parula(100), limits = c(0, top),
                       breaks = c(20, 40, 60),
                       name = expression("Alk (mg L"^-1*")"),
                       na.value = "#F9FB0E")

f1a.iii <- plot_grid(surf_list[[1]], surf_list[[2]],
                     surf_list[[3]], bott_list[[1]],
                     surf_list[[4]], bott_list[[2]],
                     surf_list[[5]], surf_list[[6]], ncol = 2, nrow = 4, align = "hv")

ggsave("figures/f1a.iii.png", f1a.iii, width = 6.5, height = 9, units = "in", dpi = 600, bg = "white")

f1a.iv <- plot_grid(surf_list[[7]], bott_list[[3]],
                    surf_list[[8]], bott_list[[4]],
                    surf_list[[9]], bott_list[[5]],
                    surf_list[[10]], bott_list[[6]], ncol = 2, nrow = 4, align = "hv")

ggsave("figures/f1a.iv.png", f1a.iv, width = 6.5, height = 9, units = "in", dpi = 600)
```

### Calculate eco thresholds
- Calculate 75%ile using allSurface & using ponds; compare
- Calculate 75%ile threshold values per year using ponds

```{r}
ecoregion <- allSurface %>%
  filter(Station.name == "BA-594-01 / Hathaway Pond (South)" |
         Station.name == "BA-797-01 / Micah Pond" |
         Station.name == "BR-321-01 / Slough Pond" |
         Station.name == "BR-335-01 / Pine Pond" |
         Station.name == "DE-355-01 / Flax Pond" |
         Station.name == "TR-53-01 / Slough Pond" |
         Station.name == "WE-76-01 / Duck Pond" |
         Station.name == "WE-64-01 / Spectacle Pond")

thresh_Secchi <- quantile(-ecoregion$Secchi, na.rm = TRUE)[4]   ### -4.11 vs -4.15
thresh_chla <- quantile(ecoregion$Chla, na.rm = TRUE)[4]   ### 3.06 vs 3.56
thresh_TN <- quantile(ecoregion$TN, na.rm = TRUE)[4]   ### 24.5 vs 23.2
thresh_TP <- quantile(ecoregion$TP, na.rm = TRUE)[4]   ### 0.40 vs 0.45

ecoregion2 <- ponds %>%
  filter(Month == 8 | Month == 9) %>%
  filter(Station.name == "BA-594-01 / Hathaway Pond (South)" |
         Station.name == "BA-797-01 / Micah Pond" |
         Station.name == "BR-321-01 / Slough Pond" |
         Station.name == "BR-335-01 / Pine Pond" |
         Station.name == "DE-355-01 / Flax Pond" |
         Station.name == "TR-53-01 / Slough Pond" |
         Station.name == "WE-76-01 / Duck Pond" |
         Station.name == "WE-64-01 / Spectacle Pond")

thresh_Secchi2 <- quantile(-ecoregion2$Secchi, na.rm = TRUE)[4]
thresh_chla2 <- quantile(ecoregion2$Chla, na.rm = TRUE)[4]
thresh_TN2 <- quantile(ecoregion2$TN, na.rm = TRUE)[4]
thresh_TP2 <- quantile(ecoregion2$TP, na.rm = TRUE)[4]

eco_annual75 <- ecoregion2 %>%
  group_by(Year) %>%
  summarise(Secchi = quantile(-Secchi, na.rm = TRUE)[4],
            Chla = quantile(Chla, na.rm = TRUE)[4],
            TN = quantile(TN, na.rm = TRUE)[4],
            TP = quantile(TP, na.rm = TRUE)[4])

# quantile(ecoregion2$Secchi[ecoregion2$Year == 2001], na.rm = TRUE)
```

- 25%/75% for Secchi -- should be inverted or not? ## negate Secchi

### Use allSurface_cont/allBottom to calc 25th %iles

```{r}
thresh_Secchi_S <- quantile(-allSurface_cont$Secchi, na.rm = TRUE)[2]
thresh_chla_S <- quantile(allSurface_cont$Chla, na.rm = TRUE)[2]
thresh_TN_S <- quantile(allSurface_cont$TN, na.rm = TRUE)[2]
thresh_TP_S <- quantile(allSurface_cont$TP, na.rm = TRUE)[2]

thresh_TN_B <- quantile(allBottom_cont$TN, na.rm = TRUE)[2]
thresh_TP_B <- quantile(allBottom_cont$TP, na.rm = TRUE)[2]

## annual thresholds
eco_annual25 <- allSurface %>%
  group_by(Year) %>%
  summarise(Secchi = quantile(-Secchi, na.rm = TRUE)[2],
            Chla = quantile(Chla, na.rm = TRUE)[2],
            TN = quantile(TN, na.rm = TRUE)[2],
            TP = quantile(TP, na.rm = TRUE)[2])
```

### Pt. 1b
```{r}
### split time period in half
### put both time periods on same panel; lines instead of filled bars; diff. color for each
### two panels (surface + bottom) per param
### Chla & Secchi on same graphic (both surf panels)

colors <- c("2001-2011" = "dodgerblue", "2012-2023" = "violetred")

Secchi1 <- ggplot(mapping = aes(x = Secchi, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, aes(fill = "2001-2011"), col = NA, alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, aes(fill = "2012-2023"), col = NA, alpha = 0.5, bins = 60) +
  geom_vline(xintercept = 2, linetype = "dashed") +
  geom_vline(xintercept = 4.5, linetype = "dashed") +
  geom_vline(xintercept = -thresh_Secchi, col = "gold") +
  geom_vline(xintercept = -thresh_Secchi_S) +
  labs(x = "Secchi Depth (m)", y = "Proportion", title = "Surface") +
  scale_fill_manual(values = colors) +
  theme_classic() +
  theme(legend.position = c(0.85, 0.8),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.margin = margin(0, 1, 1, 1, "pt"),
        legend.text = element_text(size = 6),
        legend.key.size = unit(0.1, "in"))

MLD1 <- ggplot(mapping = aes(x = MLD, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, aes(fill = "2001-2011"), col = NA, fill = "dodgerblue", alpha = 0.5, bins = 25) +
  geom_histogram(data = allSurface_post, aes(fill = "2012-2023"), col = NA, fill = "violetred", alpha = 0.5, bins = 25) +
  #geom_vline(xintercept = 2, linetype = "dashed") +
  #geom_vline(xintercept = 4.5, linetype = "dashed") +
  #geom_vline(xintercept = -thresh_Secchi, col = "gold") +
  #geom_vline(xintercept = -thresh_Secchi_S) +
  labs(x = "Mixed-layer Depth (m)", y = "Proportion", title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Chla1 <- ggplot(mapping = aes(x = log10(Chla), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(1), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_chla), col = "gold") +
  geom_vline(xintercept = log10(thresh_chla_S)) +
  labs(x = expression("log10(Chl-a) (μg L"^-1*")"), y = "Proportion", title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

###### 11.42 etc are in uM

TN1 <- ggplot(mapping = aes(x = log10(TN), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, binwidth = 0.05) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, binwidth = 0.05) +
  geom_vline(xintercept = log10(11.42 * 14.01), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "gold") +
  geom_vline(xintercept = log10(thresh_TN_S)) +
  #xlim(0, 3) +
  ylim(0, 0.125) +
  labs(x = "log10(TN) (μg/L)", y = "Proportion", title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN2 <- ggplot(mapping = aes(x = log10(TN), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, binwidth = 0.05) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, binwidth = 0.05) +
  geom_vline(xintercept = log10(11.42 * 14.01), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "gold") +
  geom_vline(xintercept = log10(thresh_TN_B)) +
  xlim(0, 3) +
  ylim(0, 0.125) +
  labs(x = "log10(TN) (μg/L)", y = "Proportion", title = "Bottom") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP1 <- ggplot(mapping = aes(x = log10(TP), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(0.24 * 30.973762), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "gold") +
  geom_vline(xintercept = log10(thresh_TP_S)) +
  #xlim(-2, 2) +
  ylim(0, 0.105) +
  labs(x = "log10(TP) (μg/L)", y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP2 <- ggplot(mapping = aes(x = log10(TP), y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = log10(0.24 * 30.973762), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "gold") +
  geom_vline(xintercept = log10(thresh_TP_B)) +
  xlim(-2, 2) +
  ylim(0, 0.105) +
  labs(x = "log10(TP) (μg/L)", y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp1 <- ggplot(mapping = aes(x = Temp, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(0.5, 30.5) +
  ylim(0, 0.115) +
  labs(x = "Temperature (°C)", y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp2 <- ggplot(mapping = aes(x = Temp, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  xlim(0.5, 30.5) +
  ylim(0, 0.115) +
  labs(x = "Temperature (°C)", y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO1 <- ggplot(mapping = aes(x = DO, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allSurface_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allSurface_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(-0.25, 14.75) +
  ylim(0, 0.28) +
  labs(x = expression("DO (mg L"^-1*")"), y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO2 <- ggplot(mapping = aes(x = DO, y = after_stat(count / sum(count)))) +
  geom_histogram(data = allBottom_pre, col = NA, fill = "dodgerblue", alpha = 0.5, bins = 60) +
  geom_histogram(data = allBottom_post, col = NA, fill = "violetred", alpha = 0.5, bins = 60) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(-0.25, 14.75) +
  ylim(0, 0.28) +
  labs(x = expression("DO (mg L"^-1*")"), y = "Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

f1 <- ggarrange(Secchi1, Chla1, TN1, TN2, TP1, TP2, Temp1, Temp2, DO1, DO2, ncol = 2)

ggsave("figures/f1.png", f1, width = 6.5, height = 9, units = "in", dpi = 600)
```

### Same as above but density plots
```{r}
hist(na.omit(allSurface_pre$Secchi), prob = TRUE)
lines(density(na.omit(allSurface_pre$Secchi)))

hist(log10(na.omit(allSurface_pre$Secchi)), prob = TRUE)
lines(density(log10(na.omit(allSurface_pre$Secchi))))

colors <- c("2001-2011" = "dodgerblue", "2012-2023" = "violetred")

Secchi1.1 <- ggplot(mapping = aes(x = Secchi)) +
  geom_density(data = allSurface_pre, aes(col = "2001-2011"), alpha = 0.5) +
  geom_density(data = allSurface_post, aes(col = "2012-2023"), alpha = 0.5) +
  geom_vline(xintercept = 2, linetype = "dashed") +
  geom_vline(xintercept = 4.5, linetype = "dashed") +
  geom_vline(xintercept = -thresh_Secchi, col = "darkgoldenrod2") +
  geom_vline(xintercept = -thresh_Secchi_S) +
  labs(x = "Secchi Depth (m)", title = "Surface") +
  scale_color_manual(values = colors) +
  theme_classic() +
  theme(legend.position = c(0.85, 0.8),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.margin = margin(0, 1, 1, 1, "pt"),
        legend.text = element_text(size = 6),
        legend.key.size = unit(0.1, "in"))

Chla1.1 <- ggplot(mapping = aes(x = log10(Chla))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(1), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_chla), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_chla_S)) +
  labs(x = expression("log10(Chl-a) (μg L"^-1*")"), title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN1.1 <- ggplot(mapping = aes(x = log10(TN))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(11.42), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TN_S)) +
  xlim(0, 3) +
  ylim(0, 2.05) +
  labs(x = "log10(TN) (μM)", title = "Surface") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TN2.1 <- ggplot(mapping = aes(x = log10(TN))) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(11.42), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TN), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TN_B)) +
  xlim(0, 3) +
  ylim(0, 2.05) +
  labs(x = "log10(TN) (μM)", title = "Bottom") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP1.1 <- ggplot(mapping = aes(x = log10(TP))) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(0.24), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TP_S)) +
  xlim(-2, 2) +
  ylim(0, 1.55) +
  labs(x = "log10(TP) (μM)") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

TP2.1 <- ggplot(mapping = aes(x = log10(TP))) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = log10(0.24), linetype = "dashed") +
  geom_vline(xintercept = log10(thresh_TP), col = "darkgoldenrod2") +
  geom_vline(xintercept = log10(thresh_TP_B)) +
  xlim(-2, 2) +
  ylim(0, 1.55) +
  labs(x = "log10(TP) (μM)") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp1.1 <- ggplot(mapping = aes(x = Temp)) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  xlim(0.5, 30.5) +
  ylim(0, 0.19) +
  labs(x = "Temperature (°C)") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

Temp2.1 <- ggplot(mapping = aes(x = Temp)) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  xlim(0.5, 30.5) +
  ylim(0, 0.19) +
  labs(x = "Temperature (°C)") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO1.1 <- ggplot(mapping = aes(x = DO)) +
  geom_density(data = allSurface_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allSurface_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(-0.25, 14.75) +
  ylim(0, 0.425) +
  labs(x = expression("DO (mg L"^-1*")")) +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

DO2.1 <- ggplot(mapping = aes(x = DO)) +
  geom_density(data = allBottom_pre, col = "dodgerblue", alpha = 0.5) +
  geom_density(data = allBottom_post, col = "violetred", alpha = 0.5) +
  geom_vline(xintercept = 3, linetype = "dashed") +
  xlim(-0.25, 14.75) +
  ylim(0, 0.425) +
  labs(x = expression("DO (mg L"^-1*")")) +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))

f1.1 <- ggarrange(Secchi1.1, Chla1.1, TN1.1, TN2.1, TP1.1, TP2.1, Temp1.1, Temp2.1, DO1.1, DO2.1, ncol = 2)

ggsave("figures/f1.1.png", f1.1, width = 6.5, height = 9, units = "in", dpi = 600)
```

### Stats for above
```{r}
ks.test(allSurface_pre$Secchi, allSurface_post$Secchi)
ks.test(allSurface_pre$MLD, allSurface_post$MLD)
ks.test(allSurface_pre$Chla, allSurface_post$Chla)
ks.test(log10(allSurface_pre$Chla), log10(allSurface_post$Chla))
ks.test(allSurface_pre$TN, allSurface_post$TN)
ks.test(log10(allSurface_pre$TN), log10(allSurface_post$TN))
ks.test(allSurface_pre$TP, allSurface_post$TP)
ks.test(log10(allSurface_pre$TP), log10(allSurface_post$TP))
ks.test(allSurface_pre$Temp, allSurface_post$Temp)
ks.test(allSurface_pre$DO, allSurface_post$DO)
ks.test(allSurface_pre$DO_sat, allSurface_post$DO_sat)

ks.test(allBottom_pre$TN, allBottom_post$TN)
ks.test(allBottom_pre$TP, allBottom_post$TP)
ks.test(allBottom_pre$Temp, allBottom_post$Temp)
ks.test(allBottom_pre$DO, allBottom_post$DO)
ks.test(allBottom_pre$DO_sat, allBottom_post$DO_sat)
```

### Pt. 2: Ecoregion thresholds (Secchi, Chla, TN, TP)
Ponds:
-- Hathaway S (BA)
-- Micah (BA)
-- Slough (BR)
-- Pine (BR)
-- Flax (DE)
-- Slough (TR)
-- Duck (WE)
-- Spectacle (WE)

- Calculate 75%ile using allSurface & using ponds; compare
- Calculate 75%ile threshold values per year using ponds

```{r}
ecoregion <- allSurface %>%
  filter(Station.name == "BA / Hathaway Pond (South) (BA-594-01)" |
         Station.name == "BA / Micah Pond (BA-797-01)" |
         Station.name == "BR / Slough Pond (BR-321-01)" |
         Station.name == "BR / Pine Pond (BR-335-01)" |
         Station.name == "DE / Flax Pond (DE-355-01)" |
         Station.name == "TR / Slough Pond (TR-53-01)" |
         Station.name == "WE / Duck Pond (WE-76-01)" |
         Station.name == "WE / Spectacle Pond (WE-64-01)")

thresh_Secchi <- quantile(-ecoregion$Secchi, na.rm = TRUE)[4]   ### -4.11 vs -4.15
thresh_chla <- quantile(ecoregion$Chla, na.rm = TRUE)[4]   ### 3.06 vs 3.56
thresh_TN <- quantile(ecoregion$TN, na.rm = TRUE)[4]   ### 24.5 vs 23.2
thresh_TP <- quantile(ecoregion$TP, na.rm = TRUE)[4]   ### 0.40 vs 0.45

ecoregion2 <- ponds %>%
  filter(Month == 8 | Month == 9) %>%
  filter(Station.name == "BA / Hathaway Pond (South) (BA-594-01)" |
         Station.name == "BA / Micah Pond (BA-797-01)" |
         Station.name == "BR / Slough Pond (BR-321-01)" |
         Station.name == "BR / Pine Pond (BR-335-01)" |
         Station.name == "DE / Flax Pond (DE-355-01)" |
         Station.name == "TR / Slough Pond (TR-53-01)" |
         Station.name == "WE / Duck Pond (WE-76-01)" |
         Station.name == "WE / Spectacle Pond (WE-64-01)")

thresh_Secchi2 <- quantile(-ecoregion2$Secchi, na.rm = TRUE)[4]
thresh_chla2 <- quantile(ecoregion2$Chla, na.rm = TRUE)[4]
thresh_TN2 <- quantile(ecoregion2$TN, na.rm = TRUE)[4]
thresh_TP2 <- quantile(ecoregion2$TP, na.rm = TRUE)[4]

eco_annual75 <- ecoregion2 %>%
  group_by(Year) %>%
  summarise(Secchi = quantile(-Secchi, na.rm = TRUE)[4],
            Chla = quantile(Chla, na.rm = TRUE)[4],
            TN = quantile(TN, na.rm = TRUE)[4],
            TP = quantile(TP, na.rm = TRUE)[4])

# quantile(ecoregion2$Secchi[ecoregion2$Year == 2001], na.rm = TRUE)
```

- 25%/75% for Secchi -- should be inverted or not? ## negate Secchi

### Use allSurface_cont/allBottom to calc 25th %iles

```{r}
thresh_Secchi_S <- quantile(-allSurface_cont$Secchi, na.rm = TRUE)[2]
thresh_chla_S <- quantile(allSurface_cont$Chla, na.rm = TRUE)[2]
thresh_TN_S <- quantile(allSurface_cont$TN, na.rm = TRUE)[2]
thresh_TP_S <- quantile(allSurface_cont$TP, na.rm = TRUE)[2]

thresh_TN_B <- quantile(allBottom_cont$TN, na.rm = TRUE)[2]
thresh_TP_B <- quantile(allBottom_cont$TP, na.rm = TRUE)[2]

## annual thresholds
eco_annual25 <- allSurface %>%
  group_by(Year) %>%
  summarise(Secchi = quantile(-Secchi, na.rm = TRUE)[2],
            Chla = quantile(Chla, na.rm = TRUE)[2],
            TN = quantile(TN, na.rm = TRUE)[2],
            TP = quantile(TP, na.rm = TRUE)[2])
```

### Plot annual threshold values

```{r}
m1 <- lm(eco_annual75$Secchi ~ eco_annual75$Year)
summary(m1)

m1.1 <- lm(eco_annual25$Secchi ~ eco_annual25$Year)
summary(m1.1)

p1 <- ggplot() +
  geom_point(data = eco_annual75, aes(x = Year, y = Secchi)) +
  geom_point(data = eco_annual25, aes(x = Year, y = Secchi), shape = 1) +
  geom_smooth(data = eco_annual75, aes(x = Year, y = Secchi), method = "lm", se = FALSE) +
  geom_smooth(data = eco_annual25, aes(x = Year, y = Secchi), method = "lm", se = FALSE, col = "red",
              linetype = "dashed") +
  geom_hline(yintercept = -4.5, linetype = "dashed") +
  geom_hline(yintercept = -2, linetype = "dashed") +
  annotate("text", x = 2004, y = -0.4, label = "slope: -0.04\nP-value: 0.295", col = "blue", size = 3) +
  annotate("text", x = 2020, y = -0.4, label = "slope: -0.01\nP-value: 0.604", col = "red", size = 3) +
  ylim(-8, 0) +
  theme_classic()
  
m2 <- lm(eco_annual75$Chla ~ eco_annual75$Year)
summary(m2)

m2.1 <- lm(eco_annual25$Chla ~ eco_annual25$Year)
summary(m2.1)

p2 <- ggplot() +
  geom_point(data = eco_annual75, aes(x = Year, y = Chla)) +
  geom_point(data = eco_annual25, aes(x = Year, y = Chla), shape = 1) +
  geom_smooth(data = eco_annual75, aes(x = Year, y = Chla), method = "lm", se = FALSE) +
  geom_smooth(data = eco_annual25, aes(x = Year, y = Chla), method = "lm", se = FALSE, col = "red",
              linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  annotate("text", x = 2004, y = 9, label = "slope: 0.07\nP-value: 0.396", col = "blue", size = 3) +
  annotate("text", x = 2020, y = 9, label = "slope: -0.02\nP-value: 0.427", col = "red", size = 3) +
  scale_y_continuous(limits = c(0, 9.5), breaks = c(0, 2, 4, 6, 8)) +
  theme_classic()

m3 <- lm(eco_annual75$TN ~ eco_annual75$Year)
summary(m3)

m3.1 <- lm(eco_annual25$TN ~ eco_annual25$Year)
summary(m3.1)

p3 <- ggplot() +
  geom_point(data = eco_annual75, aes(x = Year, y = TN)) +
  geom_point(data = eco_annual25, aes(x = Year, y = TN), shape = 1) +
  geom_smooth(data = eco_annual75, aes(x = Year, y = TN), method = "lm", se = FALSE) +
  geom_smooth(data = eco_annual25, aes(x = Year, y = TN), method = "lm", se = FALSE, col = "red",
              linetype = "dashed") +
  geom_hline(yintercept = 11.42, linetype = "dashed") +
  annotate("text", x = 2004, y = 43.5, label = "slope: 0.48\nP-value: 0.139", col = "blue", size = 3) +
  annotate("text", x = 2020, y = 43.5, label = "slope: -0.04\nP-value: 0.797", col = "red", size = 3) +
  ylim(0, 46) +
  theme_classic()

m4 <- lm(eco_annual75$TP ~ eco_annual75$Year)
summary(m4)

m4.1 <- lm(eco_annual25$TP ~ eco_annual25$Year)
summary(m4.1)

p4 <- ggplot() +
  geom_point(data = eco_annual75, aes(x = Year, y = TP)) +
  geom_point(data = eco_annual25, aes(x = Year, y = TP), shape = 1) +
  geom_smooth(data = eco_annual75, aes(x = Year, y = TP), method = "lm", se = FALSE) +
  geom_smooth(data = eco_annual25, aes(x = Year, y = TP), method = "lm", se = FALSE, col = "red",
              linetype = "dashed") +
  geom_hline(yintercept = 0.24, linetype = "dashed") +
  annotate("text", x = 2004, y = 0.9, label = "slope: 0.015\nP-value: 0.007", col = "blue", size = 3) +
  annotate("text", x = 2020, y = 0.9, label = "slope: 0.01\nP-value: 0.002", col = "red", size = 3) +
  ylim(0, 0.95) +
  theme_classic()

f2 <- ggarrange(p1, p2, p3, p4, ncol = 2)

ggsave("figures/f2.png", f2, width = 6.5, height = 5, units = "in", dpi = 600)
```

### Pt. 4: DO standard
- Calc "recent" (2016+) & annually in table

### 4a
- All ponds on one graphic; hline @ 3 mg/L
```{r}
allBottom_pre %>%
  group_by(Station.name) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 41

length(unique(allBottom_pre$Station.name))  ## 49

allBottom_post %>%
  group_by(Station.name) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 42

length(unique(allBottom_post$Station.name))  ## 49

f3 <- ggplot(mapping = aes(x = Year, y = DO)) +
  geom_point(data = allBottom) +
  geom_point(data = allBottom_pre, col = "firebrick3") +
  geom_point(data = allBottom_post, col = "firebrick3") +
  geom_hline(yintercept = 3, linetype = "dashed") +
  scale_y_continuous(breaks = c(0, 4, 8, 12)) +
  theme_classic()

ggsave("figures/f3.png", f3, width = 5, height = 3.5, units = "in", dpi = 600)

allBottom_pre %>%
  group_by(Station.name) %>%
  filter(Final.Depth > 9) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 24

length(unique(allBottom_pre$Station.name[allBottom_pre$Final.Depth > 9]))  ## 25

allBottom_post %>%
  group_by(Station.name) %>%
  filter(Final.Depth > 9) %>%
  mutate(DO_lim = ifelse(DO < 3, "< 3", ">= 3")) %>%
  count(DO_lim) %>%
  filter(DO_lim == "< 3")  ## 25

length(unique(allBottom_post$Station.name[allBottom_post$Final.Depth > 9]))  ## 25

f4 <- ggplot(mapping = aes(x = Year, y = DO)) +
  geom_point(data = allBottom[allBottom$Final.Depth > 9, ]) +
  geom_point(data = allBottom_pre[allBottom_pre$Final.Depth > 9, ], col = "firebrick3") +
  geom_point(data = allBottom_post[allBottom_post$Final.Depth > 9, ], col = "firebrick3") +
  geom_hline(yintercept = 3, linetype = "dashed") +
  scale_y_continuous(limits = c(0, 12.25), breaks = c(0, 4, 8, 12)) +
  theme_classic()

ggsave("figures/f4.png", f4, width = 5, height = 3.5, units = "in", dpi = 600)
```

### 4c (Maps w/ trends in all parameters)

######
- add units (e.g. mg/L/yr)
- crop maps to narrower area
- rotate & combine scale bars

```{r}
params <- c("Secchi", "MLD", "TN", "TP", "NtP", "Chla", "Temp", "DO", "DO_sat", "Alk")

surf_list2 <- lapply(params, function(param) {
  ggplot() +
    geom_sf(data = mass) +
    geom_point(data = slopes_surf2[!is.na(slopes_surf2[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), col = factor(sign(get(param)))),
               shape = 21) +
    geom_point(data = slopes_surf[!is.na(slopes_surf[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), fill = factor(sign(get(param)))),
               shape = 21) +
    scale_size_continuous(range = c(1, 4),
                          limits = c(sort(abs(c(slopes_surf[[param]],
                                                slopes_surf2[[param]],
                                                slopes_bott[[param]],
                                                slopes_bott2[[param]])))[1],
                                     sort(abs(c(slopes_surf[[param]],
                                                slopes_surf2[[param]],
                                                slopes_bott[[param]],
                                                slopes_bott2[[param]])), decreasing = TRUE)[1]),
                          name = "Trend\nmagnitude") +
    # scale_color_gradientn(colors = c("royalblue3", "royalblue2", "white", "firebrick", "firebrick4"),
    #                       na.value = NA,
    #                       limits = c(-sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4],
    #                                 sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4]),
    #                       name = "Trend") +
    # scale_fill_gradientn(colors = c("royalblue3", "royalblue2", "white", "firebrick", "firebrick4"),
    #                      na.value = NA,
    #                      limits = c(-sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4],
    #                                 sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4]),
    #                      name = "Trend") +
    scale_color_manual(values = c("royalblue", "black", "firebrick"),
                       breaks = c(-1, 0, 1),
                       labels = c("negative", "zero", "positive"),
                       name = "Trend\ndirection",
                       na.translate = FALSE,
                       guide = "none") +
    scale_fill_manual(values = c("royalblue", "firebrick"),
                      breaks = c(-1, 1),
                      labels = c("negative", "positive"),
                      name = "Trend\ndirection",
                      na.translate = FALSE,
                      guide = "none") +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Surface", param)) +
    theme_classic() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank())
})

bott_list2 <- lapply(params[3:7], function(param) {
  ggplot() +
    geom_sf(data = mass) +
    geom_point(data = slopes_bott2[!is.na(slopes_bott2[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), col = factor(sign(get(param)))),
               shape = 21) +
    geom_point(data = slopes_bott[!is.na(slopes_bott[[param]]), ],
               aes(x = Long, y = Lat, size = abs(get(param)), fill = factor(sign(get(param)))),
               shape = 21) +
    scale_size_continuous(range = c(1, 4), name = "Trend\nmagnitude") +
    # scale_color_gradientn(colors = c("royalblue3", "royalblue2", "white", "firebrick", "firebrick4"),
    #                       na.value = NA,
    #                       limits = c(-sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4],
    #                                 sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4]),
    #                       name = "Trend") +
    # scale_fill_gradientn(colors = c("royalblue3", "royalblue2", "white", "firebrick", "firebrick4"),
    #                      na.value = NA,
    #                      limits = c(-sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4],
    #                                 sort(abs(c(slopes_surf[[param]], slopes_surf2[[param]])), decreasing = TRUE)[4]),
    #                      name = "Trend") +
    scale_color_manual(values = c("royalblue", "black", "firebrick"),
                       breaks = c(-1, 0, 1),
                       labels = c("negative", "zero", "positive"),
                       name = "Trend\ndirection",
                       na.translate = FALSE,
                       guide = "none") +
    scale_fill_manual(values = c("royalblue", "firebrick"),
                      breaks = c(-1, 1),
                      labels = c("negative", "positive"),
                      name = "Trend\ndirection",
                      na.translate = FALSE,
                      guide = "none") +
    xlim(-70.65, -69.95) +
    ylim(41.55, 42.07) +
    labs(title = paste("Bottom", param)) +
    theme_classic() +
    theme(panel.grid = element_blank(),
          axis.title = element_blank(),
          #legend.position = "bottom",
          plot.title = element_text(face = "bold"),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank())
})

# surf_list2[[3]] <- surf_list2[[3]] +
#   scale_size_continuous(limits = c(0, 5.5), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[1]] <- bott_list2[[1]] +
#   scale_size_continuous(limits = c(0, 5.5), range = c(1, 4), name = "Trend\nmagnitude")
# 
# surf_list2[[4]] <- surf_list2[[4]] +
#   scale_size_continuous(limits = c(0, 0.4), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[2]] <- bott_list2[[2]] +
#   scale_size_continuous(limits = c(0, 0.4), range = c(1, 4), name = "Trend\nmagnitude")
# 
# surf_list2[[5]] <- surf_list2[[5]] +
#   scale_size_continuous(limits = c(0, 0.8), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[3]] <- bott_list2[[3]] +
#   scale_size_continuous(limits = c(0, 0.8), range = c(1, 4), name = "Trend\nmagnitude")
# 
# surf_list2[[6]] <- surf_list2[[6]] +
#   scale_size_continuous(limits = c(0, 0.65), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[4]] <- bott_list2[[4]] +
#   scale_size_continuous(limits = c(0, 0.65), range = c(1, 4), name = "Trend\nmagnitude")
# 
# surf_list2[[7]] <- surf_list2[[7]] +
#   scale_size_continuous(limits = c(0, 4.5), range = c(1, 4), name = "Trend\nmagnitude")
# 
# bott_list2[[5]] <- bott_list2[[5]] +
#   scale_size_continuous(limits = c(0, 4.5), range = c(1, 4), name = "Trend\nmagnitude")

f5 <- ggarrange(surf_list2[[1]], surf_list2[[2]],
                surf_list2[[3]], bott_list2[[1]],
                surf_list2[[4]], bott_list2[[2]], ncol = 2)

ggsave("figures/f5.1.png", f5, width = 6.5, height = 7, units = "in", dpi = 600)

f6 <- ggarrange(surf_list2[[5]], bott_list2[[3]],
          surf_list2[[6]], bott_list2[[4]],
          surf_list2[[7]], bott_list2[[5]], ncol = 2)

ggsave("figures/f6.1.png", f6, width = 6.5, height = 7, units = "in", dpi = 600)
```
